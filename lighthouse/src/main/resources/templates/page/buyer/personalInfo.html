<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/default_layout}">

<!-- Content -->
<div layout:fragment="content">
	<!-- BREADCRUMB -->
	<nav class="py-5">
		<div class="container">
			<div class="row">
				<div class="col-12">

					<!-- Breadcrumb -->
					<ol class="breadcrumb mb-0 fs-xs text-gray-400">
						<li class="breadcrumb-item"><a class="text-gray-400"
							href="index.html">Home</a></li>
						<li class="breadcrumb-item active">My Page</li>
					</ol>

				</div>
			</div>
		</div>
	</nav>
	
	<!-- CONTENT -->
	<section class="pt-7 pb-12">
		<div class="container">
			<div class="row">
			<div class="col-12 col-md-3">

            <!-- Nav -->
            <nav class="mb-10 mb-md-0">
              <div class="list-group list-group-sm list-group-strong list-group-flush-x">
                <a class="list-group-item list-group-item-action dropend-toggle active" th:href="@{/page/buyer/orderList}" id="orderList">
                  주문 목록
                </a>
				<ul class="list-styled mb-0">
				<li class="nav-item" tabindex="-1">

                  <!-- Toggle -->
                  <a class="list-group-item list-group-item-action dropend-toggle active" data-bs-toggle="collapse" href="#Collapse" aria-expanded="true">
                   취소/반품/교환내역
                  </a>
                  <!-- Collapse -->
                  <div class="collapse" id="Collapse" data-simplebar-collapse="#seasonGroup" tabindex="-1">
                    <div class="form-group form-group-overflow mb-6" id="seasonGroup" tabindex="-1">
                      <div class="form-check mb-3">
                       <a class="form-check-label" href="/page/buyer/cancelList" id="cancel">
                          취소
                        </a>
                      </div>
                      <div class="form-check mb-3">

                        <a class="form-check-label" href="/page/buyer/returnList" id="reList">

                          반품
                        </a>
                      </div>
                      <div class="form-check">

                        <a class="form-check-label" href="/page/buyer/exchangeList" id="exchange">

                          교환
                        </a>
                      </div>
                    </div>
                  </div>
                 </li>
                <li class="nav-item">
                <a class="list-group-item list-group-item-action dropend-toggle " th:href="@{/page/buyer/myCoupon}" id="coupon">
                  나의 쿠폰함
                </a>
                </li>
                <li class="nav-item">
                <a class="list-group-item list-group-item-action dropend-toggle " th:href="@{/page/buyer/myInquiry}" id="inquiry">
                  문의내역
                </a>
                </li>
                 <li class="nav-item">
                <a class="list-group-item list-group-item-action dropend-toggle " th:href="@{/page/buyer/wishList}" id="wish">
                  찜 목록
                </a>
                </li>
                 <li class="nav-item">
                <a class="list-group-item list-group-item-action dropend-toggle " id="myInfo" th:href="@{/page/buyer/personalInfo}">
                  개인정보 확인/수정
                </a>
                </li>
                </ul>
              </div>
            </nav>
          </div>

				<div class="col-12 col-md-9 col-lg-8 offset-lg-1">
					<!-- Form -->
					<form>
						<div class="row">
							<div class="col-12 col-md-6">
								<div class="form-group">
									<label class="form-label" for="buyerName"> 
										이름
									</label> 
									<input class="form-control form-control-sm"
										id="buyerName" type="text" placeholder="*"
										th:value="${personalInfo.memberName}" readonly>
								</div>
							</div>
							<div class="col-12">
								<!-- Email -->
								<div class="form-group">
									<label class="form-label" for="buyerEmail"> Email 주소  </label> 
									<input class="form-control form-control-sm"
										id="buyerEmail" type="email" placeholder="Email 주소"
										th:value="${personalInfo.memberEmail}" required>
								</div>
							</div>
							<div class="col-12 col-md-6">
								<!-- Password -->
								<div class="form-group">
									<label class="form-label" for="buyerPassword"> 
										새 비밀번호
									</label> 
									<input class="form-control form-control-sm"
										id="buyerPassword" type="password"  placeholder="비밀번호 수정을 원할 경우 입력해주세요">
								</div>
							</div>
							<div class="col-12 col-md-6">
								<!-- Password -->
								<div class="form-group">
									<label class="form-label" for="buyerPasswordCheck"> 
										새 비밀번호 확인
									</label> 
									<input class="form-control form-control-sm"
										id="buyerPasswordCheck" type="password"  placeholder="새 비밀번호 확인">
								</div>

							</div>
							<div class="col-12 col-md-6">
								<!-- Addr -->
	                        <div class="form-group">
	                           <label class="form-label" for="buyerAddr">
	                              주소  </label>
	                              <button type="button" style="border-radius: 10px;background-color: black; color: white;" id="addrSearch">주소검색</button>
	                              <input
	                              class="form-control form-control-sm" id="buyerAddr"
	                              type="text" placeholder="*"  th:value="${personalInfo.memberAddr}" required>
	                        </div>
							</div>
							<div class="col-12 col-md-6">
								<!-- Addr -->
								<div class="form-group">
									<label class="form-label" for="buyerDetailsAddr"> 상세주소 </label> <input class="form-control form-control-sm"
										id="buyerDetailsAddr" type="text"
										placeholder="*" th:value="${personalInfo.memberDetailsAddr}" required>
								</div>
							</div>
							
							<div class="col-12 col-md-6">
								<!-- tel -->
								<div class="form-group">
									<label class="form-label" for="buyerTel"> 전화번호 </label> <input class="form-control form-control-sm"
										id="buyerTel" type="text" 
										placeholder="숫자만 입력해주세요" th:value="${personalInfo.memberTel}" maxlength="13" required>
								</div>
							</div>							
							<div class="col-12 col-lg-6">
								<!-- Birthday -->
								<div class="form-group">
									<!-- Label -->
									<label class="form-label">생년월일</label>
									<!-- Inputs -->
									<div class="row gx-5">
										<div class="col-auto">
											<!-- Date -->
											<label class="visually-hidden" for="buyerBirth">
												Date </label> 

												<input class="form-control form-control-sm" id="buyerBirth" type="text"  
												 th:value="${personalInfo.memberBirth}" readonly required>

										</div>
									</div>

								</div>
							</div>
							</div>
							<div class="col-12">
								<!-- Button -->
								<button class="btn btn-dark" type="button" id="updateBtn" style="border-radius: 10px;">수정완료</button>
							</div>
					
					</form>

				</div>
			</div>
		</div>
	</section>
	<textarea id="orderMenual" style="display: none;">
		다음은. 번호메뉴얼 안내입니다.
		1번 주문목록.
		2번 취소목록.
		3번 반품목록.
		4번 교환목록.
		5번 나의 쿠폰함.
		6번 문의내역.
		7번 찜 목록.
		8번 개인정보 확인/수정.
		9번 메인페이지 이동.
		0번 다시듣기.
		개인정보. 페이지 정보 듣기 위해서는 탭으로 이동하면 됩니다.
	  </textarea>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
	<script>
	$(document).ready(function(){
	$('#updateBtn').on('click', function(){
		let pwData = $('#memberPw').val();
		//if( pwData != null){
		//} else {
		//	alert("새 비밀번호를 설정해주세요.")
		//	$('#buyerPassword').focus();
		//	return;
		//}
		
		let infoData = {
			'memberPw' : $('#buyerPassword').val(),
			'memberPasswordCheck' : $('#buyerPasswordCheck').val(),
			'memberAddr' : $('#buyerAddr').val(),
			'memberEmail' : $('#buyerEmail').val(),
			'memberDetailsAddr' : $('#buyerDetailsAddr').val(),
			'memberTel' : $('#buyerTel').val(),
			'memberBirth' : $('#buyerBirth').val()
		}
		
		$.ajax({
			url: '/buyer/personalInfoEdit',
			type: 'POST',
			contentType : 'application/json',
			data : JSON.stringify(infoData),
			success : function(response){

					alert("수정 완료");

			},
			error: function(err){
				console.error('정보 수정 중 오류.');
				console.log(err);
			}
		})
	});
	});
	
	$('#addrSearch').on('click',addrSearch); //주소 api
	   function addrSearch() {
	      new daum.Postcode({
	         oncomplete: function(data) {
	            $('#buyerAddr').val(data.address);
	            $('#buyerDetailsAddr').val('');
	            $('#buyerDetailsAddr').focus();
	         }
	      }).open();
	   }
	// 비밀번호 확인에서 일치 여부 확인
	/*
	$('#buyerPasswordCheck').on('focusout', function(e){
		let password = $('#buyerPassword').val();
		let passwordCheck = $('#buyerPasswordCheck').val();
		
		if(passwordCheck != password){
			alert("비밀번호가 일치하지 않습니다.");
			return;
		}
	});
	*/
	
	// 비밀번호 확인에서 pw 유효성 검사
	$('#buyerPasswordCheck').on('focusout', chkPW);
	function chkPW(){
			let password = $('#buyerPassword').val();
			let pwCheck = $('#buyerPasswordCheck').val();
			if(password != ''){
				
				if(pwCheck != password){
					alert("비밀번호가 일치하지 않습니다.");
					return;
				}
				//let pw = $("#buyerPassword").val();
				//let id = $("#id").val();
			    let checkNumber = pwCheck.search(/[0-9]/g);
			    let checkEnglish = pwCheck.search(/[a-z]/ig);
			 
			    if(!/^(?=.*[a-zA-Z])(?=.*[!@#$%^*+=-])(?=.*[0-9]).{8,25}$/.test(pwCheck)){            
			        alert('숫자+영문자+특수문자 조합으로 8자리 이상 사용해야 합니다.');
			        return false;
			    }else if(checkNumber <0 || checkEnglish <0){
			        alert("숫자와 영문자를 혼용하여야 합니다.");
			        return false;
			    }else if(/(\w)\1\1\1/.test(pwCheck)){
			        alert('같은 문자를 4번 이상 사용하실 수 없습니다.');
			        return false;
			    } else {
	
					console.log("통과");
					
					}
		}
	}
	//전화번호 숫자 외 입력방지 및 auto hypen
	$('#buyerTel').on('keyup', function(){
	    console.log(this.value);
	    this.value =  autoHypen(this.value);
	})
	function autoHypen(str){
	    str = str.replace(/[^0-9]/g, '');
	    var tmp = '';
	    if( str.length < 4){
	        return str;
	    }else if(str.length < 7){
	        tmp += str.substr(0, 3);
	        tmp += '-';
	        tmp += str.substr(3);
	        return tmp;
	    }else if(str.length < 11){
	        tmp += str.substr(0, 3);
	        tmp += '-';
	        tmp += str.substr(3, 3);
	        tmp += '-';
	        tmp += str.substr(6);
	        return tmp;
	    }else{              
	        tmp += str.substr(0, 3);
	        tmp += '-';
	        tmp += str.substr(3, 4);
	        tmp += '-';
	        tmp += str.substr(7);
	        return tmp;
	    }
	    return str
	} 
	
		//tts 시작 
		let TTSIsOk = localStorage.getItem('ttsKey');
	    let sessionAuthor;
	   console.log(sessionStorage.loginMember);          
	   if(sessionStorage.loginMember != null){
	      sessionAuthor = sessionStorage.loginMember.memberAuthor;
	   }
	       
	      function ttsInit(){
			$('#buyerName').focus();
	       if(TTSIsOk == null || sessionAuthor == 3){
	        let audioFileNow = new Audio();
	        let myName = $('#buyerName').val();
	        let firstMsg = `개인정보 확인,수정 페이지입니다. 비밀번호, 이메일, 주소, 연락처 수정할 수 있습니다.`;
	        let message = firstMsg + $('#orderMenual').val();
	        let message2 = `이름은. ${myName} 입니다. 탭키를 눌러. 다음으로 이동해주세요.`

	        VoiceMenual(message + message2);

			//tts 이벤트 부터
			$('#buyerName').on('focus',buyerName); //이름 포커스 안내
			$('#buyerEmail').on('focus',buyerEmail); // 이메일 안내
			$('#buyerPassword').on('focus', buyerPassword); //새 비밀번호 입력
			$('#buyerPasswordCheck').on('focus', buyerPasswordCheck); // 새 비밀번호 체크
			$('#buyerAddr').on('focus', buyerAddr); // 주소 안내
			$('#buyerDetailsAddr').on('focus', buyerDetailsAddr); // 상세 주소
			$('#buyerTel').on('focus',buyerTel); // 전화번호
			$('#buyerBirth').on('focus', buyerBirth);  //생년월일
			$('#updateBtn').on('focus', updateBtn); // 수정 버튼

			//이벤트 안에 사용할 전역 변수
			
			let myEmail;
			let myAddr;
			let myDetailAddr;
			let myTel;
			let myBirth;
			
			//tts 이벤트 실행
			function buyerName() { //이름 포커스 안내
				myName = $('#buyerName').val();
				VoiceMenual("이름은 : ." + myName + "입니다.탭키를 눌러. 다음으로 이동해주세요.");
			}
			function buyerEmail() { // 이메일 안내
				myEmail = $('#buyerEmail').val();
				VoiceMenual("현재 이메일은 : " + myEmail + "입니다. 수정 원할 경우. Backspace 후 새로운 이메일 작성하시면 됩니다. 이후 탭키를 눌러 다음으로 이동해주세요.");
			}
			function buyerPassword() {
				VoiceMenual('비밀번호 수정을 원할 경우만 입력해주세요. 수정을 원하면 이후 탭 키로 이동하여 방금 작성한 새 비밀번호 다시 한번 작성 필요합니다.');
			}
			function buyerPasswordCheck() {
				VoiceMenual('수정을 원하지 않으면 탭키를 눌러 다음으로 이동해주세요. 수정을 원하면 새 비밀번호를 다시 한번 비밀번호 작성 후. 탭으로 이동 필요합니다.');
			}
			function buyerAddr(){
				myAddr = $('#buyerAddr').val();
				let myAddrMessage = `현재 주소는. ${myAddr}. 입니다. 수정 원할 경우 백스페이스 후 새로운 주소 작성 후. 탭으로 이동합니다.`;
				VoiceMenual(myAddrMessage);
			}
			function buyerDetailsAddr() {
				myDetailAddr = $('#buyerDetailsAddr').val();
				let myDetailAddrMessage = `현재 상세 주소는 ${myDetailAddr}. 입니다. 수정 원할 경우 백스페이스 후 작성. 후 탭으로 이동합니다.`;
				VoiceMenual(myDetailAddrMessage);
			}
			function buyerTel() {
				myTel = $('#buyerTel').val();
				let myTelMessage = `현재 전화번호는. ${myTel}. 입니다. 수정 원할 경우 백스페이스 후 작성. 후 탭으로 이동합니다. `;
				VoiceMenual(myTelMessage);
			}
			function buyerBirth() {
				myBirth = $('#buyerBirth').val();
				let myBirthMessage = `등록된 생년월일은 ${myBirth}. 입니다. 확인 완료 하셨다면. 탭키 눌러 수정완료 버튼으로 이동합니다.`;
				VoiceMenual(myBirthMessage);
			}
			function updateBtn() {
				myName = $('#buyerName').val();
				myEmail = $('#buyerEmail').val();
				myAddr = $('#buyerAddr').val();
				myDetailAddr = $('#buyerDetailsAddr').val();
				myTel = $('#buyerTel').val();
				myBirth = $('#buyerBirth').val();
				let updateChk = `이름은. ${myName}. 이메일은. ${myEmail}. 주소는 ${myAddr}. ${myDetailAddr}. 연락처는. ${myTel}. 생년월일은 ${myBirth}. 입니다.
								수정 사항 확인 하셨다면. 엔터 입력합니다.`;
				VoiceMenual(updateChk);
			}

		//tts 부분
		console.log('hello js');

	var AudioContext;
	var audioContext;
	
	window.onload = function() {
	    navigator.mediaDevices.getUserMedia({ audio: true }).then(() => {
	        AudioContext = window.AudioContext || window.webkitAudioContext;
	        audioContext = new AudioContext();
	    }).catch(e => {
	        console.error(`Audio permissions denied: ${e}`);
	    });
	}
	
	
	function VoiceMenual(message) {
	    var data = {
	        "voice" : {
	            "languageCode" : "ko-KR",
	            "name" : "ko-KR-Neural2-B"
	        },
	        "input" : {
	            "text" : message
	        },
	        "audioConfig" : {
	            "audioEncoding" : "mp3"
	        }
	    }
	    console.log(data);
	    $.ajax({
	        type : 'POST',
	        url : 'https://texttospeech.googleapis.com/v1/text:synthesize?key=AIzaSyArcSKerGDYE7ngIVMaLhHCbNtmWN1-uac',
	        data : JSON.stringify(data),
	        dataType : 'JSON',
	        contentType : "application/json; charset=UTF-8",
	        success : function(res) {
	            $('#menuText').val(res.audioContent)
	            var audioFile = new Audio();
	            let audioBlob = base64ToBlob(res.audioContent,
	                    "mp3");
	            audioFile.src = window.URL
	                    .createObjectURL(audioBlob);
	            audioFile.playbackRate = 2; //재생속도
	            if(audioFileNow.paused == false){
	            	audioFileNow.pause();
	            }
	    		audioFileNow = audioFile;
	            audioFileNow.play();
	        
	        },
	        error : function(request, status, error) {
	            alert("오류", "오류가 발생하였습니다. 관리자에게 문의해주세요.");
	        }
	    });
	};
	function base64ToBlob(base64, fileType) {
	    let typeHeader = "data:application/" + fileType + ";base64,"; // base64 헤더 파일 유형 정의
	    let audioSrc = typeHeader + base64;
	    let arr = audioSrc.split(",");
	    let array = arr[0].match(/:(.*?);/);
	    let mime = (array && array.length > 1 ? array[1] : type) || type;
	    // url헤더 제거하고 btye로 변환
	    let bytes = window.atob(arr[1]);
	    // 예외를 처리하고 0보다 작은 ASCII 코드를 0보다 큰 값으로 변환
	    let ab = new ArrayBuffer(bytes.length);
	    // 뷰 생성(메모리에 직접): 8비트 부호 없는 정수, 길이 1바이트
	    let ia = new Uint8Array(ab);
	    for (let i = 0; i < bytes.length; i++) {
	        ia[i] = bytes.charCodeAt(i);
	    }
	    return new Blob([ ab ], {
	        type : mime
	    });
	}
	
		window.addEventListener("keydown", function(e){ 
				console.log(e);
				if(e.altKey && e.key == 1){ //주문목록
					$('#orderList').focus();
					VoiceMenual('주문목록 페이지 원할 경우. 엔터키 입력');
				}
				if(e.altKey && e.key == 2){ //취소내역
					$(".collapse").addClass("show");
					$('#cancel').focus();
					VoiceMenual('취소. 페이지 원할 경우. 엔터키 입력');
				}
				if(e.altKey && e.key == 3) {//반품내역
					$(".collapse").addClass("show")
					$('#reList').focus();
					VoiceMenual('반품. 페이지 원할 경우. 엔터키 입력');
				}
	            if(e.altKey && e.key == 4){ // 교환내역
					$(".collapse").addClass("show")
					$('#exchange').focus();
					VoiceMenual('교환. 페이지 원할 경우. 엔터키 입력');
				}
	            if(e.altKey && e.key == 5){ // 나의 쿠폰함
					$('#coupon').focus();
					VoiceMenual('쿠폰함. 페이지 원할 경우. 엔터키 입력');
				}
				if(e.altKey && e.key == 6){ // 문의내역
					$('#inquiry').focus();
					VoiceMenual('문의내역. 페이지 원할 경우. 엔터키 입력');
				}
				if(e.altKey && e.key == 7){ // 찜 목록
					$('#wish').focus();
					VoiceMenual("찜목록. 페이지 원할 경우. 엔터키 입력")
				}
				if(e.altKey && e.key == 8){ // 배송 시 요청 선택
					$('#myInfo').focus();
					VoiceMenual('개인정보 확인,수정 페이지 입니다. 엔터키 입력.');
				}
	            if(e.altKey && e.key == 9){ // 메인 페이지 이동
	                location.href = "/";
				}
				if(e.altKey && e.key == 0){ //다시 듣기
					VoiceMenual($('#orderMenual').val());
				}
		})
	  } //ttsInit()의 if문
	} // ttsInit() close 

	</script>
</div>
</html>