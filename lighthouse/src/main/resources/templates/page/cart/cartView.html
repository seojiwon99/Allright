<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default_layout}">

<!-- Content -->
<div layout:fragment="content">
    <!-- CONTENT -->
    <section class="pt-7 pb-12">
      <div class="container">
        <div class="row">
          <div class="col-12">

            <!-- Heading -->
            <h3 class="mb-10 text-center">장바구니</h3>

          </div>
        </div>
        <div class="row">
          <div class="col-12 col-md-7" id="test">
            <div>
              <input type="checkbox" id="allCheckbox">전체선택
             <button type="button" class="btn btn-sm btn-dark" id="chkDelBtn" style="float:right;">선택삭제</button>
             <hr>
            </div>

            <!-- List group -->
            <!-- 반복문 시작 -->
            <th:block th:if="${list.size != 0}">
            <div th:each="lists : ${list}">
            <ul class="list-group list-group-lg list-group-flush-x mb-6">
              <li class="list-group-item">
                <div class="row align-items-center">
                  <div class="col-3">
					
					<!-- checkbox -->
                    <input type="checkbox" name="price" th:value="${lists.productCost}">
                    <input type="hidden" name="sale" th:value="${lists.salePrice}">
                    <input type="hidden" name="delivery" th:value="${lists.deliveryCost}">
                    <input type="hidden" name="cartNum" th:value="${lists.cartCode}">
                    <input type="hidden" name="cartCnt" th:value="${lists.cartCount}">

                    <!-- Image -->
                    <a href="product.html">
                     <img th:src="@{/img/products/}+${lists.imgName}" alt="..." class="img-fluid">
                    </a>

                  </div>
                  <div class="col">
                    <!-- Title -->
                    <div class="d-flex mb-2 fw-bold">
                      <a class="text-body" href="product.html"><span th:text= "|상품명 : ${lists.productName}|"></span></a>
                      <span class="price ms-auto" th:text="| 상품금액 : ${lists.productCost}원|"></span>
                    </div>
                    <div class="d-flex mb-2 fw-bold">
                    	<span class="ms-auto" th:text="|할인금액 : ${lists.salePrice}원|"></span>
                    </div>
                    <div class="d-flex mb-2 fw-bold">
                    	<span class="ms-auto" th:text="|배송비 : ${lists.deliveryCost}원|"></span>
                    </div>

                    <!-- Text -->
                    <!--옵션 종류, 옵션 값-->
                   <p class="mb-7 fs-sm text-muted" th:text="|${lists.optionName} :  ${lists.optionValue}|"></p>
                    

                    <!--Footer -->
                    <div class="d-flex align-items-center">

                      <!-- buy plus mius -->
                      <div class="num">
                        <span>구매수량 : </span><span th:text="${lists.cartCount}"></span>
                      </div>

                      <!-- Remove -->
                      <a class="fs-xs text-gray-400 ms-auto" th:onclick="delteResult([[${lists.cartCode}]])">
                        <i class="fe fe-x"></i> 상품삭제
                      </a>
                    </div>
                  </div>
                </div>
              </li>           
            </ul>
			</div>
    </th:block>
    <th:block th:if="${list.size == 0}">
     <div>
      <li class="list-group-item">
        <div class="row align-items-center">
          <br>
          <p style="padding: 10%; font-weight: bolder; text-align: center;">장바구니에 담긴 상품이 없습니다.
          <br>원하는 상품 담아주세요!</p>
        </div>
      </li>   
     </div>
    </th:block>

            <!-- Footer -->
            <div class="row align-items-end justify-content-between mb-10 mb-md-0">
              <div class="col-12 col-md-7">
                <!-- Coupon -->
                <form class="mb-7 mb-md-0">
                  <label class="form-label fs-sm fw-bold" for="cartCouponCode">
                   
                  </label>
                  <div class="row row gx-5">
                    <div class="col">

                  
                    </div>
                    <div class="col-auto">
                      <button class="btn btn-sm btn-dark" th:onclick="shopping()">
                        쇼핑 계속하기
                       </button>
                      <!-- Button -->
                      <a class="btn btn-sm btn-dark" type="button" th:href="@{/page/buyer/myCoupon}">
                        나의 쿠폰함 가기
                      </a>

                    </div>
                  </div>
                </form>

              </div>
            </div>

          </div>
          <div class="col-12 col-md-5 col-lg-4 offset-lg-1">

            <!-- Total -->
            <div class="card mb-7 bg-light">
              <div class="card-body">
                <ul class="list-group list-group-sm list-group-flush-y list-group-flush-x">
                  <li class="list-group-item d-flex">
                    <span>상품금액</span> <span class="ms-auto fs-sm" id="productPrice">원</span>
                  </li>
                  <li class="list-group-item d-flex">
                    <span>상품할인금액</span> <span class="ms-auto fs-sm" id="salePrice">원</span>
                  </li>
                  <li class="list-group-item d-flex">
                    <span>배송비</span> <span class="ms-auto fs-sm" id="deliveryPrice">원</span>
                  </li>
                  <li class="list-group-item d-flex fs-lg fw-bold">
                    <span>결제금액</span> <span class="ms-auto fs-sm" id="totalPrice">원</span>
                  </li>
          
                </ul>
              </div>
            </div>
            <!-- th:href="@{http://localhost:8090/orders/pay}"-->
            <!-- Button -->
            <th:block th:if="${session.loginMember != null}">
              <button id="payMove" class="btn w-100 btn-dark mb-2" type="button">결제하기</button>
            </th:block>
            <th:block th:if="${session.loginMember == null}">
              <a class="btn w-100 btn-dark mb-2" th:href="@{http://localhost:8090/page/member/loginForm}">로그인</a>
            </th:block>

            <!-- Link -->
            <a class="btn btn-link btn-sm px-0 text-body" href="shop.html">
              <i class="fe fe-arrow-left me-2"></i> 쇼핑하러 가기
            </a>

          </div>
        </div>
      </div>
      
    
    </section>

    <script>
      init();
      

        //삭제
    	function delteResult(code){
        	//console.log(code);
        	//e.preventDefault()
          let deleteForm = confirm('삭제를 하시겠습니까?');
          if(deleteForm) {
        	$.ajax('http://localhost:8090/cart/delete',{
            type : 'get',
            data : {
              cartCode : code
            }
          })
          .done(data => {
            console.log(data);
            $('#test').replaceWith(data);
            init();
          })
        	
        } else {
          return;
        }
      }
      ;
      

      function init(){

  
    
    // 상품 가격, 할인가격, 결제가격 
    
    let checkboxs = $('input[name="price"]');
    let result = 0;
    let saleResult = 0;
    let deliveryResult = 0;
    let totalResult = 0;
         document.getElementById('productPrice').innerText ='원';
         document.getElementById('salePrice').innerText = '원';
         document.getElementById('deliveryPrice').innerText = '원';
         document.getElementById('totalPrice').innerText ='원';

        checkboxs.on('change', checkedCart)
        
        function checkedCart(e){
         let chk = $(this).is(':checked');
         let prices = $(this).val();
         let salcePrices = $(this).next().val();
         let deliveryPrices = $(this).next().next().val();
         let cartCnts = $(this).next().next().next().next().val();
         console.log($(this));
         
         if(chk) {
            deliveryResult+=Number(deliveryPrices);
            saleResult+=Number(salcePrices);
            result+=Number(prices);
           

         } else {
          deliveryResult-=Number(deliveryPrices);
          saleResult-=Number(salcePrices);
          result-=Number(prices);
          
          
         }
         document.getElementById('productPrice').innerText = (cartCnts * result) + '원';
         document.getElementById('salePrice').innerText = cartCnts * saleResult + '원';
         document.getElementById('deliveryPrice').innerText = deliveryResult + '원';
         document.getElementById('totalPrice').innerText = cartCnts * (result - saleResult) + deliveryResult + '원';
        }
        
    
      //전체 선택
      document.getElementById('allCheckbox')
      .addEventListener('click',allCheckEvent)
      function allCheckEvent(e) {
          let allCheckTag = document.getElementById('allCheckbox');
          let checkTags = document.querySelectorAll('input[name="price"]');
          checkTags.forEach(el => {
        	  console.log(el)
            //el.checked = allCheckTag.checked;
        	  $(el).trigger('click')
            
          })
      }
      //선택 삭제
      $('#chkDelBtn').on('click',checkedDel);

      function checkedDel(e) {
        let cartList = [];

        let checkboxes = $('input[type="checkbox"]:checked');
        checkboxes.each((idx, tag) => {
          console.log($(tag).next().next().next());
          let cartId = $(tag).next().next().next().val();
          let obj = {'cartCode' : cartId};
          cartList.push(obj);
          console.log(cartList);
        })

        let delForm = confirm('선택 삭제를 하시겠습니까?');
        if(delForm) {
        $.ajax('http://localhost:8090/cart/delete', {
          type : 'post',
          contentType : 'application/json',
          data : JSON.stringify(cartList)
        })
        .done(data => {
          $('#test').replaceWith(data);
          init();
        })
        .fail(reject => consolo.log(reject))
      } else {
        return;
        
      }
    }
    
}
$('#payMove').on('click',function(e){
  let pPrice = $('#productPrice').text();
  let pPrice2 = $('#salePrice').text();
  let pPrice3 =$('#deliveryPrice').text();
  let pPrice4=$('#totalPrice').text();

  let pay = $('#totalPrice').text();
  if(pay == '원') {
    alert('결제할 상품이 없습니다.');
    location.href = location.href;
    return;
  } else {
    localStorage.setItem("pPrice" ,pPrice)
    localStorage.setItem("pPrice2" ,pPrice2)
    localStorage.setItem("pPrice3" ,pPrice3)
    localStorage.setItem("pPrice4" ,pPrice4)
    location.href = "http://localhost:8090/orders/pay";
  }
})
    </script>
</div>
</html>