<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default_layout}">
    
<!-- Content -->
<div layout:fragment="content">
    <style>
     img {
       border-radius: 30px;
     }
   </style>
    <!-- 결제 상품 정보 -->
 
    <!-- BREADCRUMB -->
    <nav class="py-5">
      <div class="container">
        <div class="row">
          <div class="col-12">

            <!-- Breadcrumb -->
            <ol class="breadcrumb mb-0 fs-xs text-gray-400">
              <li class="breadcrumb-item">
                <a class="text-gray-400" href="/">Home</a>
              </li>
              <li class="breadcrumb-item">
                <a class="text-gray-400" th:href="@{/cart/cartView}">장바구니</a>
              </li>
              <li class="breadcrumb-item active">
                주문/결제
              </li>
            </ol>

          </div>
        </div>
      </div>
    </nav>

    <!-- CONTENT -->
    <section class="pt-7 pb-12">
      <div class="container">
        <div class="row">
          <div class="col-12 text-center">

            <!-- Heading -->
            <h3 class="mb-4">주문/결제</h3>

          </div>
        </div>
        <div class="row">
          <div class="col-12 col-md-7">

            <!-- Form -->
            <form>

              <!-- Heading -->
              <h6 class="mb-7" tabindex="0" id="orderMan">주문자 정보</h6>

              <!-- Billing details -->
              <div class="row mb-9">
                <div class="col-12">

                  <!--주문자 정보-->
                  <!-- 이름 -->
                
                  <div class="form-group">
                    <div th:each="gets,index : ${orderGet}" th:if="${index.index} < 1">
                    <label class="form-label" for="checkoutBillingFirstName">이름 *</label>
                    <div class="input-group mb-8">                      
                      <input type="text" class="form-control" id="mName" placeholder="이름 작성" aria-label="Recipient's username" aria-describedby="button-addon2" th:value="${gets.memberName}" readonly>  
                      <button class="btn btn-outline-secondary deliveryInfo" type="button" style="width: 200px; margin: 10px; background-color: black; color: white; border-radius: 10px;">배송지 정보로 등록</button>                   
                    </div>
                    </div>
                  </div>
                </div>

                <!-- 배송지 주소 -->
                <div th:each="gets,index : ${orderGet}" th:if="${index.index} < 1">
                  <div class="col-12">
                  
                    <div class="form-group">
                      <input class="form-control form-control-sm" id="mAddr" type="tel" placeholder="배송지 상세주소" required th:value="|${gets.memberAddr} , ${gets.memberDetailsAddr}|" readonly>
                      <input type="hidden" id="mAddr1" th:value="${gets.memberAddr}"> 
                      <input type="hidden" id="mAddr2" th:value="${gets.memberDetailsAddr}">
                    </div>
                  </div><br>

                  <div class="col-12">
                  <!-- Email -->
                    <div class="form-group">
                      <label class="form-label" for="checkoutBillingEmail">Email *</label>
                      <input class="form-control form-control-sm" id="mEmail" type="email" placeholder="abc@abc.com" required th:value="${gets.memberEmail}" readonly>
                  </div>
                  </div>
             
                  <div class="col-12">
                  <!-- Mobile Phone -->
                    <div class="form-group">
                     <label class="form-label" for="checkoutBillingPhone">연락처 *</label>
                     <input class="form-control form-control-sm" id="mTel" type="tel" placeholder="010-0000-0000" required th:value="${gets.memberTel}" readonly>
                    </div>
                 </div>
                </div>
                <hr>

                <!-- Heading -->
            <h6 class="mb-7">주문상품</h6>

            <!-- List group -->

            <ul class="list-group list-group-lg list-group-flush-y list-group-flush-x mb-7">
              
                <li class="list-group-item" th:each="gets : ${orderGet}">
                  <div class="row align-items-center">
                    <div class="col-3" style="width:200px; height:200px;">                   
                      <!-- Image -->
                      <a th:href="|/goodDetail?productCode=${gets.productCode}|" class="img-fluid">
                        <img th:src="|/upload/${gets.uploadPath}/${gets.uploadName}|" alt="..." width="200px"; height="200px">
                      </a>
                    </div>
                    <div class="col couponProduct">

                      <!-- Title -->
                      
                      <p class="mb-4 fs-sm fw-bold" style="margin-left: 10px">  
                         <input type="hidden" th:value="${gets.productCode}" class="productNumber">
                         <input type="hidden" th:value="${gets.optionDetailCode}" class="optionDetailCode">
                         <input type="hidden" th:value="${gets.deliveryCost}" class="deliveryMoney">
                         <input type="hidden" name="couponUsePrice" class="text-body" th:value="${gets.productName}" ><br>
                         <span class="text-muted" style="font-weight: bold;"> 상품이름 : </span><span class="text-muted pName" th:text="|${gets.productName}|" style="font-weight: bold;"></span><br>
                         <span class="text-muted"style="font-weight: bold;">상품금액 : </span><span class="text-muted pPay" style="text-decoration: line-through; font-weight: bold;" th:text="|${#numbers.formatInteger(gets.productCost,0,'COMMA')}|" id="selectPrice"></span>원 <br>
                        <span class="text-muted sPay" style="font-weight: bold;" th:text="|할인된 금액 : ${#numbers.formatInteger(gets.salePrice,0,'COMMA')}|"></span>원<br>
                        <span class="text-muted oPay" style="font-weight: bold;" th:text="|옵션 추가금액 : ${#numbers.formatInteger(gets.optionPrice,0,'COMMA')}|"></span>원
                        <input type="hidden" class="selectValue" th:value="${(gets.salePrice + gets.optionPrice) * gets.cartCount}">
                        <div class="input-group mb-8">
                          <input style="margin-top: 15px; margin-left: 10px" type="text" class="form-control cSelect" placeholder="쿠폰 선택하세요." aria-label="Recipient's username" aria-describedby="button-addon2" id="couponSelect" tabindex="-1" readonly>
                          <input type="hidden" class="myCouponCode">
                         <button type="button" class="btn btn-outline-secondary list-styled-link couponBtn" style="margin: 20px; background-color: black; color: white; border-radius: 10px;">쿠폰선택</button>
                         
                        </div> 
                        <p style="margin-left: 10px">쿠폰 할인 금액 : <input type="text" style="border-width: 0 0 1px; width: 150px;" readonly class="couponSalePrice" tabindex="-1">원 
                          <button class="btn btn-outline-secondary couponResult" type="button" style="background-color: black; color: white; border-radius: 10px;">사용하기</button>
                        </p>         
                      <!-- Text -->
                      
                        <div class="fs-sm text-muted oName" th:text="|옵션 :${gets.optionLast}|" style="font-weight: bold;"></div>
                        <div class="fs-sm text-muted pCnt" th:text="|구매수량 : ${gets.cartCount}|"  style="font-weight: bold;"></div>
                        <span style="display: flex;"> 합계금액 : <div class="fs-sm text-muted tPay" th:data-total="|${#numbers.formatInteger(((gets.salePrice + gets.optionPrice) * gets.cartCount)+ gets.deliveryCost,0,'COMMA')}|" th:text="|${#numbers.formatInteger(((gets.salePrice + gets.optionPrice) * gets.cartCount)+ gets.deliveryCost,0,'COMMA')}|"  style="font-weight: bold;"></div></span>
                        <input type="hidden" th:value="${gets.cartCount}" class="cartCnt">
                      
                    </div>
                  </div>
               </li>
            </ul>
                 <!-- Heading -->         
              <h6 class="mb-7" id="deliveryContent" tabindex="0">배송 정보</h6>
              <button class="btn btn-outline-secondary deliveryInfo" type="button" style="width: 200px; margin: 10px; background-color: black; color: white; border-radius: 10px; border-radius: 10px;" tabindex="-1">배송지 정보로 등록</button>       
                <div class="col-12">
                  <!-- Address Line 1 -->
                  <div class="form-group">
                    <label class="form-label" for="checkoutBillingAddress">받는 사람 *</label>
                    <input class="form-control form-control-sm" id="deliveryName" type="text" placeholder="이름 작성" required>
                  </div>
                </div>

                <div class="col-12">
                  <!-- Address Line 2 -->
                  <div class="form-group">
                    <div class="input-group mb-8">
                      <input type="text" class="form-control" placeholder="배송지  정보"  id="addr">
                      <button class="btn btn-outline-secondary" type="button" id="addressSearch" style="background-color: black; color: white; border-radius: 10px;">주소검색</button>
                    </div>
                  </div>
                </div>

                 <!-- 배송지 주소 -->
                <div class="col-12">
                  <div class="form-group">
                    <input class="form-control form-control-sm" type="text" placeholder="배송지 상세주소" required id="addrDt">
                  </div>
                </div><br>
            
                <div class="col-12">
                  <!-- Mobile Phone -->
                  <div class="form-group mb-0">
                    <label class="form-label" for="checkoutBillingPhone">연락처 *</label>
                    <input class="form-control form-control-sm"  type="tel" placeholder="010-0000-0000" required id="deliveryTel">
                  </div>
                  
                </div>

                <!--요청 사항-->
                <div class="col-12">
                <br>
                <h6>배송 요청사항</h6>
                <!-- Notes -->  
                <select class="form-select form-select-lg mb-3" aria-label="Large select example" id="selbox">
                  <option selected>배송 요청 선택</option>
                  <option th:each="codeValue : ${codeList}" th:value="${codeValue.codeId}" th:text="${codeValue.codeName}"></option>
                </select>
                <input type="text" id="selectDirect" class="form-control form-control-sm" placeholder="배송 기타 요청사항 작성해주세요.">

                </div>

              </div>

              <hr>
              
            
            </form>

          </div>
          <div class="col-12 col-md-5 col-lg-4 offset-lg-1">

            

            <!-- Card -->
            <div class="card mb-9 bg-light " style="position: fixed; right: 50; top: 100; border-radius: 10px; z-index: 1500">
              <div class="card-body">
                <ul class="list-group list-group-sm list-group-flush-y list-group-flush-x">
                  <li class="list-group-item d-flex">
                    <span>상품금액</span> <span style="text-decoration: line-through;" class="ms-auto fs-sm" id="productPrice"></span>원
                  </li>
                  <li class="list-group-item d-flex">
                    <span>상품할인금액</span> <span class="ms-auto fs-sm" id="salePrice"></span>원
                  </li>
                  <li class="list-group-item d-flex">
                    <span>쿠폰할인</span> <span class="ms-auto fs-sm" id="couponSale"></span>원
                  </li>
                  <li class="list-group-item d-flex">
                    <span>배송비</span> <span class="ms-auto fs-sm" id="deliveryPrice"></span>원
                  </li>
                  <li class="list-group-item d-flex fs-lg fw-bold">
                    <span>결제금액</span> <span class="ms-auto" id="totalPrice" style="color: red;"></span>원
                  </li>
                </ul>
              </div>
              <hr>
              <ul style="list-style-type: none;">
                <li>
                <p class="mb-7 fs-xs text-gray-500">
                  귀하의 개인 데이터는 귀하의 주문을 처리하고, 이 웹사이트 전반에 걸쳐 귀하의 경험을 지원하고,
                  당사의 개인 정보 보호 정책에 설명된 기타 목적을 위해 사용됩니다.
                </p>
              </li>
              </ul>
            </div>

            <!-- Disclaimer -->
          </div>
        </div>
      </div>
    </section>

    
    <!-- 토스 결제 위젯 -->
   <div class="title"></div>
     <div id="payment-method"></div>
     <div id="agreement"></div> 
  <!-- Button -->
  <div>
    <button class="btn btn-dark" id="payment-button" style="padding: 10px; width: 200px; margin: auto; display: block; border-radius: 10px;">결제하기</button>   
  </div>

  <div>
    <br>
  </div>


  <!-- MODALS -->
  <!-- Newsletter: Horizontal -->
  <div class="modal fade" id="modalNewsletterHorizontal" tabindex="-1" role="dialog" aria-hidden="true" style="z-index:2000">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">

        <!-- Close -->
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
          <i class="fe fe-x" aria-hidden="true"></i>
        </button>
  
        <!-- Content -->
       
          <div class="col-12 col-lg-16 d-flex flex-column px-md-8">
  
            <!-- Body -->
            <div class="modal-body my-auto py-10" id="couponPage">
              
              <style>
                table{
                  border-collapse: separate;
                  font-size: 11px;
                  border: 1px solid white;
                }
                tr:hover {
                  background-color: #ddd;
                }
                td, th {
                  text-align: center;
                  font-size: 12px;
                  border-radius: 16px;
                  border: 1px solid white;
                }
                .select-button:hover {
                    background-color:#002ead;
                    transition: 0.7s;
                }
                .tableCss{
                  border: 1px solid #ffebb5;
                  background-color: #ffebb5;
                  border-radius: 16px;
                }
              </style>
              <!-- Heading -->
              <h4 id="myCouponbox" tabindex="0">나의 쿠폰함</h4>
              <div class="tableCss">
                <table class="table table-bordered" style="border-collapse: collapse;">
                  <thead>
                    <tr>
                      <th>쿠폰코드</th>
                      <th>쿠폰명</th>
                      <th>내용</th>
                      <th>할인금액(원,율)</th>
                      <th>발급일자</th>
                      <th>사용종료일자</th>
                      <th>선택</th>
                    </tr>
                    
                  </thead>
                  <tbody> 
                    <tr class="clickable-row" th:each="couponRest : ${couponList}">
                      <td class="cpCode" th:text="${couponRest.couponCode}" th:data-max="${couponRest.couponMaxPrice}" th:data-min="${couponRest.couponMinPrice}" tabindex="0"></td>
                      <td class="cpName" th:text="${couponRest.couponName}"></td>
                      <td class="cpContent" th:text="${couponRest.couponContent}"></td>
                      <td class="cpDiscount" th:text="${couponRest.couponDiscountPrice} == '0' ? |${couponRest.couponDiscountRate}%| : |${#numbers.formatInteger(couponRest.couponDiscountPrice,0,'COMMA')}원|"></td>
                      <td class="cpIssueDate" th:text="${#dates.format(couponRest.issueDate, 'yy/MM/dd')}"></td> 
                      <td class="cpEndDate" th:text="${#dates.format(couponRest.endDate, 'yy/MM/dd')}"></td>
                      <td><button type="button" class="btn btn-warning btn-circle btn-xxs mb-1 select-button" tabindex="0"><i class="fe fe-check"></i></button></td>     
                    </tr>
                    </tbody>
                  </table>
              </div>
            </div>
          </div>
       </div>
  </div>
</div>
  <textarea id="orderInfo" style="display: none;">
    1번 결제하기.
    2번 가입한 배송지 주소로 배송지 등록입니다. alt 2번 이동 후 스페이스바 입력필요합니다.
    3번 첫번째 주문상품으로 이동 후 조회.
    4번 배송지 정보 조회.
    5번 배송 시 요청 선택.
    6번 주문자 정보 확인.
    9번 메인 페이지 이동.
    0번 다시 듣기.

  </textarea>
    <script th:src="@{/js/theme.bundle.js}"></script>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script th:src="@{/js/theme.bundle.js}"></script>
    <script th:inline="javascript">
    

    //주소 api로 입력
    $('#addressSearch').on('click', addrPopup);
    function addrPopup(){
        new daum.Postcode({
            oncomplete: function(data) {
                $('#addr').val(data.address);
                $("#addrDt").focus();
            }
        
        }).open();
    }
    //상품 금액 연산 정리
    let result = 0; // 총금액
    let couponAmount = 0;
    let deliveryPay = 0;
    let saleToal = 0;
    let productTotal = 0;
    let toalPay=0;
    let couponTarget;
    let getPrice = [[${orderGet}]];
    let couponarry = [[${couponList}]];
    console.log(couponarry);
    console.log(getPrice)
    
      // total 가격 나중에 쿠폰 가격  빼야함.
      for(let key in  getPrice) {
      result = result + (( getPrice[key].optionPrice + getPrice[key].salePrice ) * getPrice[key].cartCount);  
      }
      // 배송비
      let pList = [];
      for(let key in getPrice) {
        if(!(pList.includes(getPrice[key].productCode))) {
          pList.push(getPrice[key].productCode);
          deliveryPay = deliveryPay + (getPrice[key].deliveryCost);
        }
      }
      //할인 상품 가격
      for(let key in getPrice) {
        saleToal = saleToal + (getPrice[key].salePrice +  getPrice[key].optionPrice) * getPrice[key].cartCount;
      }
      result = result + deliveryPay;
      // 상품 가격
      for(let key in getPrice) {
        productTotal = productTotal + ((getPrice[key].productCost )* getPrice[key].cartCount);
      }
      // 상품 가격 - 상품 할인가격
      let realPrice = productTotal - saleToal;
      console.log(realPrice);

      function formatComma(number) {
        return number.toLocaleString();
      }

      $('#productPrice').text(formatComma(productTotal)); // 상품금액
      $('#salePrice').text(formatComma(saleToal)); // 상품할인 금액
      $('#deliveryPrice').text(formatComma(deliveryPay)); // 배송비
      $('#totalPrice').text(formatComma(result)); // 총금액 
     

        let productNum = "";
         let coupon;     
        let roundPrice = 0;
        let couponNum =0;
        const myModal =  new window.Modal(document.getElementById('modalNewsletterHorizontal'))
    

        //모달 창 쿠폰 값 주문 페이지 넘기기
        $('.couponBtn').on('click', function(e){        
         coupon = e.target;

         myModal.show();
        })
   
        
        function closeModal(){
          myModal.hide();
        }
        $('#modalNewsletterHorizontal').on('hidden.bs.modal', function(){
          $(coupon).closest(".list-group-item").find('.couponResult').focus();
        })
        
    $('#modalNewsletterHorizontal').on('shown.bs.modal', function(){
      $('#myCouponbox').focus();
      $('.select-button').off("click");
      $('.select-button').on('click',function(e){
        
        let thisRow = $(this).closest('tr');

        let maxPrice =  thisRow.find('td:eq(0)').data('max'); // 최소 사용 금액
        let minPrice = thisRow.find('td:eq(0)').data('min'); // 최대 할인율 - 할인금액
       
        let couponNum = thisRow.find('td:eq(0)').text();
        let couName = thisRow.find('td:eq(1)').text(); 
        let fmNum = thisRow.find('td:eq(3)').text().replaceAll(",", "");
        fmNum = fmNum.replace("원","");
        fmNum = fmNum.replace("%","");
        let couDiscount = Number(fmNum);
        
        
        let couponDisRt = Number($(coupon).closest(".list-group-item").find('.selectValue').val()); // 상품 가격
        if(couponDisRt < minPrice) { // 쿠폰 최소 금액 사용 조건
          alert(minPrice + "원이 최소 사용금액입니다.") 
          return false;
        }

        if(couDiscount < 100) {
          couDiscount  = couponDisRt * couDiscount / 100;
          if(couDiscount > maxPrice) { // 할인쿠폰 최대 사용 제한 조건
            alert(maxPrice + '원이 최대 할인금액 입니다.');
            couDiscount = maxPrice;
          }
        } else {
          couDiscount;
        }
        roundPrice = (Math.ceil(couDiscount / 100) * 100);
        console.log(roundPrice);
        
        if(roundPrice >= couponDisRt) {
          alert('쿠폰 할인금액 보다 상품 가격이 적습니다.')
          return false;
        }

        let flag = false;
        $('.myCouponCode[value]').each(function(idx,el){
          if(el.value == couponNum){               
            flag = true;
            return false;
          }               
        })
        if(flag){
          alert("사용된 쿠폰입니다.");
            return;
        }          
        $(coupon).closest(".list-group-item").find('.couponSalePrice').val(formatComma(roundPrice));
        $(coupon).closest(".list-group-item").find('#couponSelect').val(couName);          
        $(coupon).closest(".list-group-item").find('.myCouponCode').val(couponNum);   
        //$('#modalNewsletterHorizontal').modal('hide'); //모달 닫기
        closeModal();
        $(coupon).closest(".list-group-item").find('.couponResult').focus();
        $(coupon).closest(".list-group-item").find('.couponResult').prop("disabled",false);
      });
      
    }) 

    

    let conponAll = 0;

    //총 금액에서 쿠폰 값 빼기
    $('.couponResult').on('click', function(e){
            conponAll = 0;
           
            $('.couponSalePrice').each(function(idx,el){
              let formatNumber = el.value.replaceAll(",","");
              conponAll = conponAll + Number(formatNumber)
             
            })
            
            console.log(conponAll);

            couDiscount = $('#couponSale').text(formatComma(conponAll));

              Number($('#totalPrice').text(formatComma(result-conponAll)));
              toalPay  =  Number(result-conponAll);
              
              let price = $(this).closest('.list-group-item').find('.tPay').data('total')
              price = price.replaceAll(",","");
              console.log($(this).prev().val());
              let salePayPrice = $(this).prev().val();
              salePayPrice = salePayPrice.replaceAll(",","");
              console.log(salePayPrice);

              console.log($(this).closest('.list-group-item').find('.tPay').data('total'));
              $(this).prop("disabled",true);
              let couponProPay = $(this).closest('.list-group-item').find('.tPay').text((Number(price) - Number(salePayPrice)).toLocaleString('ko-KR'));
              console.log(toalPay);
              console.log(couponProPay);
              
            
        })
            

    //배송 요청 사항 직접 입력시 생성
    $('#selectDirect').hide();
    $('#selbox').change(function(){
      if($('#selbox').val() == 4) {
        $('#selectDirect').show();
        $('#selectDirect').focus();
      } else {
        $('#selectDirect').hide();
      }
    });

    // 배송 요청 사항 본인 내용 넘길 때 버튼
    $('.deliveryInfo').on('click', function(e){
      $('#deliveryName').val($('#mName').val());
      $('#addr').val($('#mAddr1').val());
      $('#addrDt').val($('#mAddr2').val());
      $('#deliveryTel').val($('#mTel').val()); 
    });
    
   //토스 위젯
      const clientKey = 'test_ck_GjLJoQ1aVZJKQEvkvAWVw6KYe2RN' // 상점을 특정하는 키
    const customerKey = 'YbX2HuSlsC9uVJW6NMRMj' // 결제 고객을 특정하는 키
    
    // 할인 쿠폰 금액

   
    let amount = Number($('#totalPrice').text()); // 결제 금액
    
    console.log(amount);

  /*결제위젯 영역 렌더링*/
  const paymentWidget = PaymentWidget(clientKey, customerKey) // 회원 결제
  //paymentMethods = paymentWidget.renderPaymentMethods('#payment-method', amount)
  
  /*약관 영역 렌더링*/
  const paymentAgreement = paymentWidget.renderAgreement('#agreement')

  
  
  /*결제창 열기*/
  document.querySelector("#payment-button").addEventListener("click",()=>{

    if( $('#deliveryName').val() == '' || $('#addr').val() == '' || $('#addrDt').val() == '' || $('#deliveryTel').val() == '') {
      alert('배송 정보 빈칸 없이 작성해주세요.');
      return false;
    }
    $('.text-gray-300').last().focus();
    let amount = $('#totalPrice').text(); // 결제 금액
    amount = amount.replaceAll(",","");
    Number(amount);
    paymentWidget.renderPaymentMethods('#payment-method', amount)
    let uuid = self.crypto.randomUUID().slice(0,-10);

    //save 주문 내역 insert 할 데이터
    let deliveryReq = '';
    if($('#selbox').val() == 4) {
      deliveryReq = $('#selectDirect').val();
    } else {
      deliveryReq = $('#selbox').val();
    }
    // productCode productSalePrice
    let deliveryVO =
    {
        orderPrice : Number(amount),
        orderAddr : $('#addr').val(),
        orderDetailsAddr : $('#addrDt').val(),
        recipientName : $('#deliveryName').val(),
        recipientTel : $('#deliveryTel').val(),
        requestedTerm : deliveryReq
    }

    let orderPayVO =[];     
     $('.couponProduct').each(function(idx,el){
     let orderList ={};
            if($(el).find('.myCouponCode').val() != '') {
              orderList.couponCode = $(el).find('.myCouponCode').val();
              orderList.optionDetailCode = $(el).find('.optionDetailCode').val();
              orderList.productSalePrice = $(el).find('.selectValue').val();
              let couponValue = $(el).find('.couponSalePrice').val().replace(",","");
              orderList.couponPrice = couponValue;
              orderList.deliveryCost = $(el).find('.deliveryMoney').val();
              orderList.cartCount = $(el).find('.cartCnt').val();
              orderPayVO.push(orderList)
            }
     })
    
     
    //ajax - async:false - 비동식 save 데이터 받아서 보냄
    $.ajax('/orders/save',{
      async:false,
      type : 'post', 
      data : JSON.stringify({deliveryVO : deliveryVO , orderPayVO : orderPayVO}),   //{변수명 : 변수값}   data : JSON.stringify({orderPayVO:orderPayVO, orderPayVO :provo}),  리스트 넣기.
      contentType : 'application/json'
    })

    paymentWidget.requestPayment({
      orderId: uuid,
      orderName: [[${productName}]],
      successUrl: 'http://localhost:8090/orders/credit',
      failUrl: 'https://allright1.shop/orders/fail',
      customerEmail: [[${orderGet[0].memberEmail}]], 
      customerName: [[${orderGet[0].memberName}]]
      }).catch(function (error) {
          if (error.code === 'USER_CANCEL') {// 결제 고객이 결제창을 닫았을 때 에러 처리
          } if (error.code === 'INVALID_CARD_COMPANY') { // 유효하지 않은 카드 코드에 대한 에러 처리
          }
      })  
     
  })

  let TTSIsOk = localStorage.getItem('ttsKey');
    let sessionAuthor;
      console.log(sessionStorage.loginMember);          
      if(sessionStorage.loginMember != null){
         sessionAuthor = sessionStorage.loginMember.memberAuthor;
      }
       
      function ttsInit(){
       if(TTSIsOk == null || sessionAuthor == 3){

    
    
    let audioFileNow = new Audio();
    let firstMsg = "주문 결제 페이지입니다. 배송지, 상품 가격을 확인 후 결제 진행하시면 됩니다.";
      let message =  firstMsg + $('#orderInfo').val();
    
      VoiceMenual(message); 


    //tts 내용 이벤트 부여
    $('#payment-button').on('focus', payInfo); //결제버튼 포커스
    $('.deliveryInfo').on('focus', deliveryContent); // 배송지로 등록 포커스
    $('.deliveryInfo').on('keyup', deliverySuccess); // 배송지 등록 완료
    $('a.img-fluid').on('focus',productInfo);
    $('#deliveryContent').on('focus',deliveryInfo); //배송지 정보 읽어 줌.
    $('#selbox').on('change', deliveryRequest); // 배송 요청 사항 안내
    $('.couponBtn').on('focus',couponChoice); //쿠폰 선택 안내
    $('.cpCode').on('focus', couponInfo); // 각 쿠폰 안내
    $('#myCouponbox').on('focus',myCouponBox); // 나의 쿠폰함 안내
    $('.select-button').on('focus', couponSelect); //쿠폰 선택 전 안내
    $('.couponResult').on('focus', couponUse); //쿠폰 사용 금액 및 사용 전 안내
    $('.couponResult').on('keydown', couponRs); // 쿠폰 사용 안내
    $('.cpCode').on('keydown', couponCheck); // 쿠폰 alert 창 tts로 먼저 확인
    $('#orderMan').on('focus',orderManInfo); //주문자 정보

    //tts 이벤트 진행
    function payInfo() { // 결제 전 금액 확인
      if( $('#deliveryName').val() == '' || $('#addr').val() == '' || $('#addrDt').val() == '' || $('#deliveryTel').val() == '') {
      VoiceMenual('배송 정보 빈칸 없이 작성해주세요.');
      return;
    }
      let productPay = $('#productPrice').text();
      let salePay = $('#salePrice').text();
      let couponPay = $('#couponSale').text();
      let deliveryPay = $('#deliveryPrice').text();
      let totalPay = $('#totalPrice').text();
      let payInfoMessage = `총 상품 금액은. ${productPay}원. 할인 받은 상품 금액은. ${salePay}원. 쿠폰 할인 금액은. ${couponPay}원.
                            배송비는. ${deliveryPay}원. 총 결제 금액은. ${totalPay}원. 입니다. 결제 원할 경우. 엔터키 입력`;
      VoiceMenual(payInfoMessage);
    }

    function deliveryContent() { //배송지 주소로 선택 버튼
      VoiceMenual("현재 주소지. 배송지로 원할 경우. 스페이스바 입력.");
      
    }
    function deliverySuccess(e) { // 배송지 주소 입력시 성공 여부
      if(e.code == 'Space'){
        $('.deliveryInfo').trigger('click');

        if($('#deliveryName').val() != '') {
          VoiceMenual('배송지 등록 되었습니다.')
        } else {
          VoiceMenual('배송지 등록에 실패했습니다.')
        } 
      }
    }
    function orderManInfo(){
    let manName =  $('#mName').val();
    let manAddr =  $('#mAddr1').val();
    let manAddr1 = $('#mAddr2').val();
    let manTel =   $('#mTel').val();
    let manMessage = `주문자 이름은. ${manName}. 주소는. ${manAddr}. ${manAddr1}. 전화번호는. ${manTel} 입니다.
                      현재 주문자. 정보로 배송지 원할 경우. alt, 2 눌러서 이동하세요.`;
    VoiceMenual(manMessage);
    }

    function productInfo() { //주문 전 상품 확인
      let prName = $(this).parent().parent().find('.pName').text();
      let prPay = $(this).parent().parent().find('.pPay').text();
      let saPay = $(this).parent().parent().find('.sPay').text();
      let otPay = $(this).parent().parent().find('.oPay').text();
      let coSelect;
      let couponSalePay;

      if($(this).parent().parent().find('.cSelect').val() == '') {
        coSelect = "선택된 쿠폰이 없습니다.";
      } else {
        coSelect = $(this).parent().parent().find('.cSelect').val();
      }

      if($(this).parent().parent().find('.couponSalePrice').val() == '') {
        couponSalePay = 0;
      } else {
        couponSalePay = $(this).parent().parent().find('.couponSalePrice').val();
      }

      let otName = $(this).parent().parent().find('.oName').text(); 
      let prCnt = $(this).parent().parent().find('.pCnt').text(); 
      let payPrice = $(this).parent().parent().find('.tPay').text(); 
      let productDetailInfo = `선택된 상품의 이름은. ${prName}. 선택한. ${otName}. 할인 받지 않은 가격은. ${prPay}원. ${saPay}원.

                              ${otPay}원. 선택한 쿠폰은. ${coSelect}. 쿠폰 할인 금액은. ${couponSalePay}원. 구매 ${prCnt}. 합계금액은. ${payPrice}원. 입니다. 쿠폰 선택 원할 경우 탭으로 이동 부탑드립니다.`;
      VoiceMenual(productDetailInfo);
    }

    function deliveryInfo() { //배송지 정보 읽어줌
        let recipient = $('#deliveryName').val();
        let recipientAddr = $('#addr').val();
        let recipientAddrDt = $('#addrDt').val();
        let recipientDeliverTel = $('#deliveryTel').val();
        
        let recipientSelbox = $('#selbox').val();
        if(recipientSelbox == 2) {
          recipientSelbox = "배송 전에 미리 연락 바랍니다.";
        } else if (recipientSelbox == 1) {
          recipientSelbox = "부재 시 경비실에 맡겨주세요.";
        } else if (recipientSelbox == 3) {
          recipientSelbox = "부재시 전화 또는 문자 남겨주세요";
        } else if (recipientSelbox == 4) {
          recipientSelbox = $('#selectDirect').val();
        }

        let recipientMessage = `받는 사람 ${recipient}. 받는 주소 ${recipientAddr}. ${recipientAddrDt}. 연락처 ${recipientDeliverTel}. 요청사항 ${recipientSelbox}. 선택했습니다.
                                만약 요청사항 선택하지 않은 경우. alt 5번으로 이동 후. 위.아래 키로 하시면 됩니다.`;
        VoiceMenual(recipientMessage);
    }
    function deliveryRequest() { //배송 요청 사항 정보 안내
        let deliveryRespon = $('#selbox').val();
        if(deliveryRespon == 2) {
          deliveryRespon = "배송 전에 미리 연락 바랍니다.";
        } else if (deliveryRespon == 1) {
          deliveryRespon = "부재 시 경비실에 맡겨주세요.";
        } else if (deliveryRespon == 3) {
          deliveryRespon = "부재시 전화 또는 문자 남겨주세요";
        } else if (deliveryRespon == 4) {
          deliveryRespon = "직접 입력 입니다. 작성 후 alt 4번으로 내용 다시 확인해 주세요.";
          VoiceMenual(deliveryRespon);
        }
          VoiceMenual(deliveryRespon);
    }

    function couponChoice() { //현재 상품 쿠폰 선택 버튼
        VoiceMenual("현재 상품에 대한 쿠폰 선택 원할 경우 스페이스바 클릭하여 나의 쿠폰함으로 이동합니다.");
    }

    function myCouponBox() { //나의 쿠폰함 안내.
      if(couponarry == '') {
        VoiceMenual('현재 사용 가능한. 쿠폰이 없습니다. ESC로 창을 닫아주세요.');
        return;
      }
      VoiceMenual('나의 쿠폰함입니다. 탭키로 이동하여 쿠폰 내용 확인 후. 쿠폰 선택하면 적용됩니다.');
    }

    function couponInfo() { //현재 쿠폰 정보
      
      let cpCode = $(this).parent().find('.cpCode').text();
      let cpName = $(this).parent().find('.cpName').text();
      let cpContent = $(this).parent().find('.cpContent').text();
      let cpDiscount = $(this).parent().find('.cpDiscount').text();
      let cpIssueDate = $(this).parent().find('.cpIssueDate').text();
      let cpEndDate = $(this).parent().find('.cpEndDate').text();
      let couponMessage = `쿠폰번호는. ${cpCode}. 쿠폰 이름은. ${cpName}. 쿠폰 내용은. ${cpContent}. 
                          쿠폰 할인 금액. 또는 할인율은. ${cpDiscount}. 발급일자는. ${cpIssueDate}. 사용종료 일자는. ${cpEndDate} 입니다.
                          사용을 원할 경우. 탭키 사용하여. 선택 버튼으로 이동해주세요.`;
      VoiceMenual(couponMessage);
      
    }

    function couponSelect(){ // 나의 쿠폰함 선택 버튼 안내.
      VoiceMenual('현재 쿠폰 선택 원할 경우 스페이스바 눌러주세요.');
    }

    function couponUse(){
      if($(this).parent().parent().find('.couponSalePrice').val() == '') {
        couponSalePay = 0;
      } else {
        couponSalePay = $(this).parent().parent().find('.couponSalePrice').val();
      }
      let couponVal = `쿠폰 할인 금액은 ${couponSalePay}원.입니다. 사용 원할 경우 스페이스바 눌러주세요.`;
      VoiceMenual(couponVal);
    }

    function couponRs(e) {
      if(e.code == 'Space'){
        VoiceMenual('쿠폰 사용 되었습니다.');
      }
    }


    //tts alert창 확인
    function couponCheck() { //쿠폰 alert창 확인
        let thisRow = $(this).closest('tr');
        console.log(thisRow);
        let maxPrice =  thisRow.find('td:eq(0)').data('max'); // 최소 사용 금액
        let minPrice = thisRow.find('td:eq(0)').data('min'); // 최대 할인율 - 할인금액
       
        let couponNum = thisRow.find('td:eq(0)').text();
        let couName = thisRow.find('td:eq(1)').text(); 
        let couDiscount = Number(thisRow.find('td:eq(3)').text().slice(0,-1));
        
        let couponDisRt = Number($(coupon).closest(".list-group-item").find('.selectValue').val()); // 상품 가격
      if(couponDisRt < minPrice) { // 쿠폰 최소 금액 사용 조건
        VoiceMenual(minPrice + "원이 최소 사용금액입니다. 탭키를 눌러. 다음 쿠폰으로. 이동해주세요.") 
        return;
        }

        if(couDiscount < 100) {
          couDiscount  = couponDisRt * couDiscount / 100;
          if(couDiscount > maxPrice) { // 할인쿠폰 최대 사용 제한 조건
            VoiceMenual(maxPrice + '원이. 최대 할인금액 입니다. 사용 원할 경우 탭키 두번 눌러주세요.');
            couDiscount = maxPrice;
          }
        } else {
          couDiscount;
        }
        roundPrice = (Math.ceil(couDiscount / 100) * 100);
        console.log(roundPrice);
        
        if(roundPrice >= couponDisRt) {
          VoiceMenual('쿠폰 할인금액 보다 상품 가격이 적습니다. 탭키를 눌러. 다음 쿠폰으로. 이동해주세요.')
          return;
        }

        let flag=false;
        $('.myCouponCode[value]').each(function(idx,el){
          if(el.value == couponNum){               
            flag = true;
            return false;
          }               
        })
        if(flag){
          VoiceMenual("사용된 쿠폰입니다. 탭키를 눌러. 다음 쿠폰으로. 이동해주세요.");
            return;
        }        
    }
  
  console.log('hello js');

var AudioContext;
var audioContext;

window.onload = function() {
    navigator.mediaDevices.getUserMedia({ audio: true }).then(() => {
        AudioContext = window.AudioContext || window.webkitAudioContext;
        audioContext = new AudioContext();
    }).catch(e => {
        console.error(`Audio permissions denied: ${e}`);
    });
}


function VoiceMenual(message) {
    var data = {
        "voice" : {
            "languageCode" : "ko-KR",
            "name" : "ko-KR-Neural2-B"
        },
        "input" : {
            "text" : message
        },
        "audioConfig" : {
            "audioEncoding" : "mp3"
        }
    }
    console.log(data);
    $.ajax({
        type : 'POST',
        url : 'https://texttospeech.googleapis.com/v1/text:synthesize?key=AIzaSyArcSKerGDYE7ngIVMaLhHCbNtmWN1-uac',
        data : JSON.stringify(data),
        dataType : 'JSON',
        contentType : "application/json; charset=UTF-8",
        success : function(res) {
            $('#menuText').val(res.audioContent)
            var audioFile = new Audio();
            let audioBlob = base64ToBlob(res.audioContent,
                    "mp3");
            audioFile.src = window.URL
                    .createObjectURL(audioBlob);
            audioFile.playbackRate = 2; //재생속도
            if(audioFileNow.paused == false){
               audioFileNow.pause();
            }
          audioFileNow = audioFile;
            audioFileNow.play();
        
        },
        error : function(request, status, error) {
            alert("오류", "오류가 발생하였습니다. 관리자에게 문의해주세요.");
        }
    });
};
function base64ToBlob(base64, fileType) {
    let typeHeader = "data:application/" + fileType + ";base64,"; // base64 헤더 파일 유형 정의
    let audioSrc = typeHeader + base64;
    let arr = audioSrc.split(",");
    let array = arr[0].match(/:(.*?);/);
    let mime = (array && array.length > 1 ? array[1] : type) || type;
    // url헤더 제거하고 btye로 변환
    let bytes = window.atob(arr[1]);
    // 예외를 처리하고 0보다 작은 ASCII 코드를 0보다 큰 값으로 변환
    let ab = new ArrayBuffer(bytes.length);
    // 뷰 생성(메모리에 직접): 8비트 부호 없는 정수, 길이 1바이트
    let ia = new Uint8Array(ab);
    for (let i = 0; i < bytes.length; i++) {
        ia[i] = bytes.charCodeAt(i);
    }
    return new Blob([ ab ], {
        type : mime
    });
}



   window.addEventListener("keydown", function(e){ 
         console.log(e);
         if(e.altKey && e.key == 1){ //결제하기
            $('#payment-button').focus();
         }
         if(e.altKey && e.key == 2){ // 가입한 배송지 주소로 배송지 등록
            $('.deliveryInfo')[0].focus();
         }
         if(e.altKey && e.key == 3) {//첫번째 주문상품 이동
         console.log($('.img-fluid'));
            $('a.img-fluid')[0].focus();
         }
      if(e.altKey && e.key == 4){ // 배송지 정보 조회
            $('#deliveryContent').focus();
         }
      if(e.altKey && e.key == 5){ // 배송 시 요청 선택
            $('#selbox').focus();
         }
      if(e.altKey && e.key == 6){ // 주문자 정보 이동
            $('#orderMan').focus();
         }
      if(e.altKey && e.key == 9){ // 메인 페이지 이동
                location.href = "/";
         }
         if(e.altKey && e.key == 0){ //다시 듣기
            VoiceMenual($('#orderInfo').val());
         }
   })
   } //ttsInit()의 if문
  } // ttsInit() close
   
    </script>
</div>
</html>
