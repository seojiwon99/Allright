<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/default_layout}">

<!-- Content -->
<div layout:fragment="content">

	<!-- CONTENT -->
	<section class="pt-7 pb-12">
		<div class="container">
			<div class="row">
				<div class="col-12 text-center">

					<!-- Heading -->
					<h3 class="mb-10">취소 상세 페이지</h3>

				</div>
			</div>
			<div class="row">
				<div class="col-12 col-md-3">

					<!-- Nav -->
					<nav class="mb-10 mb-md-0">
						<div
							class="list-group list-group-sm list-group-strong list-group-flush-x">
							<a
								class="list-group-item list-group-item-action dropend-toggle active"
								th:href="@{/page/buyer/orderList}" id="orderList" tabindex="-1"> 주문 목록 </a>
							<ul class="list-styled mb-0">
								<li class="nav-item">
									<!-- Toggle --> <a
									class="list-group-item list-group-item-action dropend-toggle active"
									data-bs-toggle="collapse" href="#Collapse" aria-expanded="true" tabindex="-1">
										취소/반품/교환내역 </a> <!-- Collapse -->
									<div class="collapse" id="Collapse"
										data-simplebar-collapse="#seasonGroup">
										<div class="form-group form-group-overflow mb-6"
											id="seasonGroup">
											<div class="form-check mb-3">
												<a class="form-check-label" 
													href="/page/buyer/cancelList" id="cancel" tabindex="-1"> 취소 </a>
											</div>
											<div class="form-check mb-3">
												<a class="form-check-label" 
													href="/page/buyer/returnList" id="reList" tabindex="-1"> 반품 </a>
											</div>
											<div class="form-check">
												<a class="form-check-label" 
													href="/page/buyer/exchangeList" id="exchange" tabindex="-1"> 교환 </a>
											</div>
										</div>
									</div>
								</li>
								<li class="nav-item"><a
									class="list-group-item list-group-item-action dropend-toggle "
									th:href="@{/page/buyer/myCoupon}" id="coupon" tabindex="-1"> 나의 쿠폰함 </a></li>
								<li class="nav-item"><a
									class="list-group-item list-group-item-action dropend-toggle "
									th:href="@{/page/buyer/myInquiry}" id="inquiry" tabindex="-1"> 문의내역 </a></li>
								<li class="nav-item"><a
									class="list-group-item list-group-item-action dropend-toggle "
									th:href="@{/page/buyer/wishList}" id="wish" tabindex="-1"> 찜 목록 </a></li>
								<li class="nav-item"><a
									class="list-group-item list-group-item-action dropend-toggle "
									th:href="@{/page/buyer/personalInfo}" id="myInfo" tabindex="-1"> 개인정보 확인/수정 </a></li>
							</ul>
						</div>
					</nav>

				</div>
				<div class="col-12 col-md-9 ">
					<!-- Order -->
							<div th:if="${cancelList.size != 0}">
							<!-- 반복문 시작 -->
							<!-- Info -->
							<div class="card card-sm order border mb-7" th:each="lists : ${cancelList}"  id="test">
									<div class="card-body bg-light" style="border-radius: 15px;">
										<div class="row cancelRow">
										<div class="col-9 mb-6">
										 <div class="row">
											<div class="col-lg-3">
												<span class="heading-xxs text-muted">취소 번호:</span>
												<p class="mb-lg-0  fw-bold">
													<span class="cancelCode" th:text="|${lists.cancelCode}|" tabindex="0" id="cancelCode"></span>
												</p>
											</div>
											<div class="col-lg-3">
												<span class="heading-xxs text-muted">주문번호/상세</span>
												<p class="mb-0  fw-bold">
													<span class="orderCode" th:text="|${lists.orderCode}|"></span>
													/<span class="orderDetailCode" th:text="|${lists.orderDetailCode}|"
														id="orderDetailCode"></span>
												</p>
											</div>
											<div class="col-lg-6">
												<span class="heading-xxs text-muted">상품명:</span>
												<p class="mb-0  fw-bold">
													<span class="productName" th:text="|${lists.productName}|"></span>
												</p>
											</div>
										</div>
											<div class="row mt-6">
											<div class="col-lg-3">
			                                    <span class="heading-xxs text-muted">결제 금액:</span>
			                                    <p class="mb-0  fw-bold">
			                                       <span class="paymentPrice" th:text="|${#numbers.formatInteger(lists.paymentPrice,0,'COMMA')}원|"></span>
			                                    </p>
			                                 </div>
											<div class="col-lg-3">
												<span class="heading-xxs text-muted">취소 접수 날짜:</span>
												<p class="mb-lg-0  fw-bold">
													<time datetime="2019-10-01">
														<span class="cancelRegdate"
															th:text="|${#dates.format(lists.cancelRegdate, 'yyyy-MM-dd')}|"></span>
													</time>
												</p>
											</div>
											<div class="col-lg-3">
												<span class="heading-xxs text-muted">취소 승인 여부:</span>
												<p class="mb-0  fw-bold">
													<span class="cancelStatus" th:text="|${lists.cancelStatus}|"></span>
												</p>
											</div>
											<div class="col-lg-3">
												<span class="heading-xxs text-muted">수량:</span>
												<p class="mb-0  fw-bold">
													<span class="orderCnt" th:text="|${lists.orderCnt}|"></span>
												</p>
											</div>
											<!-- 
											<div class="col-6 col-lg-3">
												<h6 class="heading-xxxs text-muted">취소 승인 날짜:</h6>
												<p class="mb-0 fs-sm fw-bold">
													<span class="cancelDate" th:text="|${#dates.format(lists.cancelDate, 'yyyy-MM-dd')}|"></span>
												</p>
											</div>
											 -->
											 </div>
										</div>
										<div class="col-3" style="padding-left: 0px;">
												<img th:src="|/upload/${lists.uploadPath}/${lists.uploadName}|"
													style="max-width: 100%; height: auto">
										</div>
											
										</div>
											<div class="col-12 col-lg-6">
												<div class="row gx-5">
													<div class="col-6" >
				                                       <button
				                                             class="btn btn-sm w-100 btn-outline-dark deleteBtn"
				                                             th:onclick="deleteCancel([[${lists.orderDetailCode}]])"
				                                             th:data-orderdetailcode="${lists.orderDetailCode}"
				                                             th:id="${lists.orderDetailCode}"
				                                             style="background-color: black; color: white; border-radius: 10px">
				                                             취소 철회</button>
				                                     </div>
												</div>
											</div>
									</div>
									<div class="card-footer" th:if="${lists.cancelStatus != '승인'}">
										<div class="row align-items-center">
							</div>
							</div>
							<div id="noSearch" tabindex=-1>
							<th:block th:if="${cancelList.size == 0}">
								<div>
								     <ul>
								      <li class="list-group-item">
								        <div class="row align-items-center">
								          <br>
										  <a href="/page/buyer/orderList" id="noSearch">
										  <p style="padding: 10%; font-weight: bolder; text-align: center;">반품 신청한 상품이 없습니다.
										  <br>주문 목록에서 신청 가능합니다.
										  </p>
										  </a>
								        </div>
								      </li>
								      </ul>   
							     </div>
							</th:block>
							</div>
						</div>
					</div>
				</div>
								<!-- Pagination -->
					<nav class="d-flex justify-content-center justify-content-md-end mt-10">
						<ul class="pagination pagination-sm text-gray-400">
							<li class="page-item" th:if="${pageMaker.prev}">
								<a class="page-link page-link-arrow"
									th:href="@{/page/buyer/cancelList/(pageNum = ${pageMaker.startPage - 1})}">
										<i class="fa fa-caret-left"></i>
								</a>
							</li>
							<th:block
								th:with="start = ${pageMaker.startPage}, end = ${pageMaker.endPage}">
								<li th:if="${pageMaker.endPage} ne 0"
									th:with="start = ${pageMaker.startPage}, end = ${pageMaker.endPage}"
									th:each="pageButtom : ${#numbers.sequence(start,end)}"
									th:class="${pageMaker.cri.pageNum} eq ${pageButtom} ? 'page-item active' : 'page-item'">
									<a class="page-link" href="#"
									th:href="@{/page/buyer/cancelList/(pageNum= ${pageButtom} )}"
									th:text="${pageButtom}"></a>
								</li>
							</th:block>
							<li class="page-item" th:if="${pageMaker.next}"><a
								class="page-link page-link-arrow"
								th:href="@{/page/buyer/cancelList/(pageNum = ${pageMaker.endPage + 1})}">
									<i class="fa fa-caret-right"></i>
							</a></li>
						</ul>
					</nav>
			</div>
		</div>
	</section>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<textarea id="orderMenual" style="display: none;">
      1번 주문목록.
      2번 취소목록.
      3번 반품목록.
      4번 교환목록.
      5번 나의 쿠폰함.
      6번 문의내역.
      7번 찜 목록.
      8번 개인정보 확인/수정.
      9번 메인페이지 이동.
      0번 다시듣기.
    </textarea>
	<script>
	function deleteCancel(code){
		let cancelDel = confirm('주문 취소를 철회하시겠습니까?');
		let cancelData = {
			'orderDetailCode' : code,
		}
		if(cancelDel){
			$.ajax('/buyer/deleteCancel',{			
				type : 'POST',
				contentType : 'application/json',
				data : JSON.stringify(cancelData)
			})
			.done(data => {
					//alert("수정 완료");
					console.log(data);
					$('#test').replaceWith(data);
   					if($('.order').length == 0){
						let htmltags = `
						<div>
						     <ul>
						      <li class="list-group-item">
						        <div class="row align-items-center">
						          <br>
								  <a href="/page/buyer/orderList">
								  <p style="padding: 10%; font-weight: bolder; text-align: center;">취소 신청한 상품이 없습니다.
								  <br>주문 목록에서 신청 가능합니다.
								  </p>
								  </a>
						        </div>
						      </li>
						      </ul>   
					     </div>`
					     $('#noSearch').append(htmltags);
   					}
			})
			}else{
				return;
			}
		};
	
	//tts 시작 
    let TTSIsOk = localStorage.getItem('ttsKey');
      let sessionAuthor;
     console.log(sessionStorage.loginMember);          
     if(sessionStorage.loginMember != null){
        sessionAuthor = sessionStorage.loginMember.memberAuthor;
     }
         
        function ttsInit(){
         if(TTSIsOk == null || sessionAuthor == 3){
          let audioFileNow = new Audio();
          let firstMsg = "취소 목록 페이지입니다. 취소 신청한 내역에 대해서 확인할 수 있습니다.";
          let message = firstMsg + $('#orderMenual').val();

          VoiceMenual(message);
			
          function deleteCancelForTTS(code){
      		let cancelData = {
      			'orderDetailCode' : code,
      		}
   			$.ajax('/buyer/deleteCancel',{			
   				type : 'POST',
   				contentType : 'application/json',
   				data : JSON.stringify(cancelData)
   			})
   			.done(data => {
   					//alert("수정 완료");
   					console.log(data);
   					$('#test').replaceWith(data);
   					if($('.order').length == 0){
						let htmltags = `
						<div>
						     <ul>
						      <li class="list-group-item">
						        <div class="row align-items-center">
						          <br>
								  <a href="/page/buyer/orderList">
								  <p style="padding: 10%; font-weight: bolder; text-align: center;">취소 신청한 상품이 없습니다.
								  <br>주문 목록에서 신청 가능합니다.
								  </p>
								  </a>
						        </div>
						      </li>
						      </ul>   
					     </div>`
						$('#noSearch').append(htmltags);
					    $('#noSearch').focus();
					   // VoiceMenual('주문 취소 철회가 완료되었습니다. 현재 취소 신청한 상품이 없습니다. 주문 목록에서 신청 가능합니다. 엔터키를 누르면 주문 목록으로 이동합니다.')
					    
   					}
   			})

      		};
    //tts 이벤트 부여
    $('.cancelCode').on('focus', cancelListInfo);
    $('.deleteBtn').on('focus', deleteBtn);
    $('#noSearch').on('focus', noSearch);
    //tts 이벤트 진행
    $('.deleteBtn').on('keydown',function(e){
       	if(e.key == 'Enter'){
       	 e.preventDefault();
	       	 if($(this).prop('class') == 'btn btn-sm w-100 btn-outline-dark deleteBtn'){
	       		 deleteCancelForTTS(this.id);
	       	 }
        }
    })
    function noSearch(){
    	VoiceMenual('취소 신청한 상품이 없습니다. 현재 주문 목록에서 신청 가능합니다. 엔터키를 누르면 주문 목록으로 이동합니다.');
    }
    function cancelListInfo() {
    	let cancelCode = $(this).closest('.cancelRow').find('.cancelCode').text();
    	let orderCode = $(this).closest('.cancelRow').find('.orderCode').text();
    	let orderDetailCode = $(this).closest('.cancelRow').find('.orderDetailCode').text();
    	let productName = $(this).closest('.cancelRow').find('.productName').text();
    	let orderCnt = $(this).closest('.cancelRow').find('.orderCnt').text();
    	let paymentPrice = $(this).closest('.cancelRow').find('.paymentPrice').text();
    	let cancelRegdate = $(this).closest('.cancelRow').find('.cancelRegdate').text();
    	let cancelStatus = $(this).closest('.cancelRow').find('.cancelStatus').text();
    	
    	
    	let message = `취소번호는 ${cancelCode}. 주문번호는 ${orderCode}. 주문상세번호는 ${orderDetailCode}. 상품명은 ${productName}.
    					상품 수량은 ${orderCnt}.  결제 금액은 ${paymentPrice}. 취소 접수날짜는 ${cancelRegdate}. 
    					취소 승인 여부는. ${cancelStatus}. 입니다.`;
    	
    	VoiceMenual(message);
    }
    
   	function deleteBtn() {
   		VoiceMenual('취소 철회 버튼입니다. 취소 철회를 원하시면. 엔터키를 눌러주세요.');
   	}
    
		
		//tts 부분
	    console.log('hello js');

	var AudioContext;
	var audioContext;

	window.onload = function() {
	    navigator.mediaDevices.getUserMedia({ audio: true }).then(() => {
	        AudioContext = window.AudioContext || window.webkitAudioContext;
	        audioContext = new AudioContext();
	    }).catch(e => {
	        console.error(`Audio permissions denied: ${e}`);
	    });
	}


	function VoiceMenual(message) {
	    var data = {
	        "voice" : {
	            "languageCode" : "ko-KR",
	            "name" : "ko-KR-Neural2-B"
	        },
	        "input" : {
	            "text" : message
	        },
	        "audioConfig" : {
	            "audioEncoding" : "mp3"
	        }
	    }
	    console.log(data);
	    $.ajax({
	        type : 'POST',
	        url : 'https://texttospeech.googleapis.com/v1/text:synthesize?key=AIzaSyArcSKerGDYE7ngIVMaLhHCbNtmWN1-uac',
	        data : JSON.stringify(data),
	        dataType : 'JSON',
	        contentType : "application/json; charset=UTF-8",
	        success : function(res) {
	            $('#menuText').val(res.audioContent)
	            var audioFile = new Audio();
	            let audioBlob = base64ToBlob(res.audioContent,
	                    "mp3");
	            audioFile.src = window.URL
	                    .createObjectURL(audioBlob);
	            audioFile.playbackRate = 2; //재생속도
	            if(audioFileNow.paused == false){
	               audioFileNow.pause();
	            }
	          audioFileNow = audioFile;
	            audioFileNow.play();
	        
	        },
	        error : function(request, status, error) {
	            alert("오류", "오류가 발생하였습니다. 관리자에게 문의해주세요.");
	        }
	    });
	};
	function base64ToBlob(base64, fileType) {
	    let typeHeader = "data:application/" + fileType + ";base64,"; // base64 헤더 파일 유형 정의
	    let audioSrc = typeHeader + base64;
	    let arr = audioSrc.split(",");
	    let array = arr[0].match(/:(.*?);/);
	    let mime = (array && array.length > 1 ? array[1] : type) || type;
	    // url헤더 제거하고 btye로 변환
	    let bytes = window.atob(arr[1]);
	    // 예외를 처리하고 0보다 작은 ASCII 코드를 0보다 큰 값으로 변환
	    let ab = new ArrayBuffer(bytes.length);
	    // 뷰 생성(메모리에 직접): 8비트 부호 없는 정수, 길이 1바이트
	    let ia = new Uint8Array(ab);
	    for (let i = 0; i < bytes.length; i++) {
	        ia[i] = bytes.charCodeAt(i);
	    }
	    return new Blob([ ab ], {
	        type : mime
	    });
	}
		
	   window.addEventListener("keydown", function(e){ 
	         console.log(e);
	         if(e.altKey && e.key == 1){ //주문목록
	             $('#orderList').focus();
	             VoiceMenual('주문목록 페이지 원할 경우. 엔터키 입력');
	          }
	         else if(e.altKey && e.key == 2){ //취소내역
	        	 $(".collapse").addClass("show")
	             $('#cancel').focus();
	             VoiceMenual('취소. 페이지 원할 경우. 엔터키 입력');
	          }
	         else if(e.altKey && e.key == 3) {//반품내역
	        	 $(".collapse").addClass("show")
	             $('#reList').focus();
	             VoiceMenual('반품. 페이지 원할 경우. 엔터키 입력');
	          }
	         else if(e.altKey && e.key == 4){ // 교환내역
	        	 $(".collapse").addClass("show")
	             $('#exchange').focus();
	             VoiceMenual('교환. 페이지 원할 경우. 엔터키 입력');
	          }
	         else if(e.altKey && e.key == 5){ // 나의 쿠폰함
	             $('#coupon').focus();
	             VoiceMenual('쿠폰함. 페이지 원할 경우. 엔터키 입력');
	          }
	         else if(e.altKey && e.key == 6){ // 문의내역
	             $('#inquiry').focus();
	             VoiceMenual('문의내역. 페이지 원할 경우. 엔터키 입력');
	          }
	         else if(e.altKey && e.key == 7){ // 찜 목록
	             $('#wish').focus();
	             VoiceMenual("찜목록. 페이지 원할 경우. 엔터키 입력")
	          }
	         else if(e.altKey && e.key == 8){ // 배송 시 요청 선택
	             $('#myInfo').focus();
	             VoiceMenual('개인정보 확인,수정 페이지 입니다. 엔터키 입력.');
	          }
	         else if(e.altKey && e.key == 9){ // 메인 페이지 이동
	                 location.href = "/";
	          }
	         else if(e.altKey && e.key == 0){ //다시 듣기
	             VoiceMenual($('#orderMenual').val());
	          }
	   })
	  } //ttsInit()의 if문
	} // ttsInit() close

	</script>
</div>
</html>
