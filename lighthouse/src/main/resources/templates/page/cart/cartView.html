<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default_layout}">

<!-- Content -->
<div layout:fragment="content">
    <!-- CONTENT -->
    <section class="pt-7 pb-12">
      <div class="container">
        <div class="row">
          <div class="col-12">

            <!-- Heading -->
            <h3 class="mb-10 text-center" tabindex="1">장바구니</h3>
			
			
          </div>
        </div>
        <div class="row">
          <div class="col-12 col-md-7" id="test">
            <div>
              <input type="checkbox" id="allCheckbox">전체선택
             <button type="button" class="btn btn-sm btn-dark" id="chkDelBtn" style="float:right;" tabindex="-1">선택삭제</button>
             <hr>
            </div>

            <!-- List group -->
            <!-- 반복문 시작 -->
            <div th:if="${list.size != 0}" id="cartItem">
            <div th:each="lists, listStat : ${list}">
            <ul class="list-group list-group-lg list-group-flush-x mb-6">
              <li class="list-group-item">
                <div class="row align-items-center">
                  <div class="col-3">
					
					<!-- checkbox -->
                    <input type="checkbox" name="price" th:value="${lists.productCost}" class="firstPro">
                    <input type="hidden" name="sale" th:value="${lists.salePrice}">
                    <input type="hidden" name="delivery" th:value="${lists.deliveryCost}">
                    <input type="hidden" name="cartNum" th:value="${lists.cartCode}">
                    <input type="hidden" name="cartCnt" th:value="${lists.cartCount}">
                    <input type="hidden" name="optionPrice" th:value="${lists.optionPrice}">

                    <!-- Image -->
                    <a href="product.html" tabindex="-1">
                     <img th:src="|/upload/${lists.uploadPath}/${lists.uploadName}|" alt="..." class="img-fluid" tabindex="-1">
                    </a>

                  </div>
                  <div class="col checkContent">
                    <!-- Title -->
                    <div class="d-flex mb-2 fw-bold">
                      <a class="text-body" href="product.html" tabindex="-1"><span th:text= "|상품명 : ${lists.productName}|"class="tts1" tabindex="-1"></span></a>
                      <span class="price ms-auto tts2" style="text-decoration: line-through;" th:text="| 상품금액 : ${lists.productCost}원|"></span>
                    </div>
                    <div class="d-flex mb-2 fw-bold">
                    	<span class="ms-auto tts3" th:text="|할인된 금액 : ${lists.salePrice}원|"></span>
                    </div>
                    <div class="d-flex mb-2 fw-bold">
                    	<span class="ms-auto tts4" th:text="|옵션 추가금액 : ${lists.optionPrice}원|"></span>
                    </div>
                    <div class="d-flex mb-2 fw-bold">
                    	<span class="ms-auto tts5" th:text="|배송비 : ${lists.deliveryCost}원|"></span>
                    </div>

                    <!-- Text -->
                    <!--옵션 종류, 옵션 값-->
                   <p class="mb-7 fs-sm text-muted tts6" th:text="${lists.optionLast}"></p>
                    

                    <!--Footer -->
                    <div class="d-flex align-items-center">

                      <!-- buy plus mius -->
                      <div class="num">
                        <span>구매수량 : </span><span th:text="${lists.cartCount}" class="tts7"></span>
                      </div>

                      <!-- Remove -->
                      <a class="fs-xs text-gray-400 ms-auto" th:onclick="delteResult([[${lists.cartCode}]])">
                        <button class="fe fe-x productDel" tabindex="0"></button> 상품삭제
                      </a>
                    </div>
                  </div>
                </div>
              </li>           
            </ul>
			</div>
    </div>
    <th:block th:if="${list.size == 0}">
     <div>
     <ul>
      <li class="list-group-item">
        <div class="row align-items-center">
          <br>
          <p style="padding: 10%; font-weight: bolder; text-align: center;">장바구니에 담긴 상품이 없습니다.
          <br>원하는 상품 담아주세요!</p>
        </div>
      </li>
      </ul>   
     </div>
    </th:block>

            <!-- Footer -->
            <div class="row align-items-end justify-content-between mb-10 mb-md-0">
              <div class="col-12 col-md-7">
                <!-- Coupon -->
                <form class="mb-7 mb-md-0">
                  <label class="form-label fs-sm fw-bold" for="cartCouponCode">
                   
                  </label>
                  <div class="row row gx-5">
                    <div class="col">

                  
                    </div>
                    <div class="col-auto">
                      <button class="btn btn-sm btn-dark" th:onclick="shopping()" id="shoping">
                        쇼핑 계속하기
                       </button>
                      <!-- Button -->
                      <a class="btn btn-sm btn-dark" type="button" th:href="@{/page/buyer/myCoupon}">
                        나의 쿠폰함 가기
                      </a>

                    </div>
                  </div>
                </form>

              </div>
            </div>

          </div>
          <div class="col-12 col-md-5 col-lg-4 offset-lg-1">

            <!-- Total -->
            <div class="card mb-7 bg-light">
              <div class="card-body">
                <ul class="list-group list-group-sm list-group-flush-y list-group-flush-x">
                  <li class="list-group-item d-flex">
                    <span>상품금액</span> <span style="text-decoration: line-through;" class="ms-auto fs-sm" id="productPrice">원</span>
                  </li>
                  <li class="list-group-item d-flex">
                    <span>상품할인금액</span> <span class="ms-auto fs-sm" id="salePrice">원</span>
                  </li>
                  <li class="list-group-item d-flex">
                    <span>배송비</span> <span class="ms-auto fs-sm" id="deliveryPrice">원</span>
                  </li>
                  <li class="list-group-item d-flex fs-lg fw-bold">
                    <span>결제금액</span> <span class="ms-auto fs-sm" id="totalPrice">원</span>
                  </li>
          
                </ul>
              </div>
            </div>
            <!-- Button -->
              <button id="payMove" class="btn w-100 btn-dark mb-2" type="button">결제하기</button>
            <!-- Link -->
            <a class="btn btn-link btn-sm px-0 text-body" href="shop.html">
              <i class="fe fe-arrow-left me-2"></i> 쇼핑하러 가기
            </a>

          </div>
        </div>
      </div>
      
    
    </section>
    <!--cart 메뉴얼 tts-->
    <textarea id="cartMenual" style="display: none;">
      1번 결제버튼 이동 후 엔터키 사용하면 주문페이지 이동.
      2번 장바구니 상품 전체선택 포커싱.
      3번 첫번째 상품으로 이동.
      6번 메인 페이지 이동.
      0번 메뉴얼 다시 듣기.
    </textarea>

    <script>
  let audioFileNow = new Audio();
  let firstMsg = "장바구니 페이지 입니다. 회원이 담은 상품들을 확인하고 결제를 할 수 있습니다." + "탭을 눌러 이동하며, 체크박스에서는 스페이스바로  선택 가능합니다.";
  let message =  firstMsg + $('#cartMenual').val();

	$(function(){
  		init();
  		checkedCart();
      VoiceMenual(message);
	})
	
	function init(){
		
		//이벤트 지정
    $('#allCheckbox').on('click',allCheckEvent);  // 전체선택
    $('#allCheckbox').on('focus',allFocus); // 전체선택 포커스 될 경우 read
    $('#allCheckbox').on('keydown',allKeydown); // 키 눌렀을 경우 읽어줌
    $('input[name="price"]').on('change', checkedCart);
    $('#chkDelBtn').on('click',checkedDel);                    //선택 삭제
    $('.productDel').on('focus',productDel);  // 상품  삭제 read
    $('#payMove').on('focus',patMove); // 주문 페이지 안내 - 결제 클릭
    $('input[name="price"]').on('keydown', proKeydown);
    $('#shoping').on('focus',shoping);

    $('input[name="price"]').on('focus', function productDetail(){
       let proName = $(this).parent().parent().find('.tts1').text(); //상품명
       let proPrice = $(this).parent().parent().find('.tts2').text(); //상품금액
       let proSalePrice = $(this).parent().parent().find('.tts3').text()//할인금액
       let optionVal = $(this).parent().parent().find('.tts4').text() //옵션 추가 금액
       let proDelivery = $(this).parent().parent().find('.tts5').text() //배송비
       let optionName = $(this).parent().parent().find('.tts6').text() //옵션종류, 옵션 값
       let buyCnt = $(this).parent().parent().find('.tts7').text() //구매수량
       let productMsg = `${proName}. ${proPrice}. ${proSalePrice}. ${optionVal}. ${proDelivery}. 선택한 옵션의 종류는 ${optionName}. 구매수량은 ${buyCnt} 입니다.
                        전체선택을 하지 않고 개별 선택의 경우 스페이스바로 선택해주세요.`;
      
        VoiceMenual(productMsg);
    });

    
    document.getElementById('productPrice').innerText ='원';
    document.getElementById('salePrice').innerText = '원';
    document.getElementById('deliveryPrice').innerText = '원';
    document.getElementById('totalPrice').innerText ='원';
  }

        //삭제
  function delteResult(code){
          let deleteForm = confirm('삭제를 하시겠습니까?');
          if(deleteForm) {
        	$.ajax('http://localhost:8090/cart/delete',{
            type : 'get',
            data : {
              cartCode : code
            }
          })
          .done(data => {
            console.log(data);
            $('#test').replaceWith(data);
            init();
          })
        	
        } else {
          return;
        }
  };
      

      
      
  function checkedCart(){
    // 상품 가격, 할인가격, 결제가격     
    let result = 0;
    let saleResult = 0;
    let deliveryResult = 0;
    let totalResult = 0;

    let checkboxes = $('#cartItem input[type="checkbox"]:checked');
    checkboxes.each((idx, tag) => {

        let prices = $(tag).val();
        let salcePrices = Number($(tag).next().val());
        let deliveryPrices = $(tag).next().next().val();
        let cartCnts = $(tag).next().next().next().next().val();
        let optionPrice= Number($(tag).next().next().next().next().next().val());

        deliveryResult+=Number(deliveryPrices);
        saleResult+=Number((salcePrices + optionPrice) * cartCnts);
        result+=Number(prices * cartCnts);
    })

    document.getElementById('productPrice').innerText = result + '원';
    document.getElementById('salePrice').innerText = saleResult + '원';
    document.getElementById('deliveryPrice').innerText = deliveryResult + '원';
    document.getElementById('totalPrice').innerText = saleResult + deliveryResult + '원';
  }   
    
      //전체 선택
      function allCheckEvent(e) {
          let allCheckTag = document.getElementById('allCheckbox');
          let checkTags = document.querySelectorAll('input[name="price"]');
          checkTags.forEach(el => {
        	  console.log(el)
            //el.checked = allCheckTag.checked;
        	  $(el).trigger('click')  
          })
      }


      function checkedDel(e) {
        let cartList = [];

        let checkboxes = $('input[type="checkbox"]:checked');
        checkboxes.each((idx, tag) => {
          console.log($(tag).next().next().next());
          let cartId = $(tag).next().next().next().val();
          let obj = {'cartCode' : cartId};
          cartList.push(obj);
          console.log(cartList);
        })

        let delForm = confirm('선택 삭제를 하시겠습니까?');
        if(delForm) {
        $.ajax('http://localhost:8090/cart/delete', {
          type : 'post',
          contentType : 'application/json',
          data : JSON.stringify(cartList)
        })
        .done(data => {
          $('#test').replaceWith(data);
          init();
        })
        .fail(reject => consolo.log(reject))
      } else {
        return;
        
      }
    }
    
    // tts 정리
    function allKeydown(e) {
        if(e.keyCode === 32 && $('#allCheckbox').is(':checked') == false) {
          VoiceMenual("장바구니 상품 전체 선택 되었습니다.");
        } else if(e.keyCode === 32 && $('#allCheckbox').is(':checked') == true){
          VoiceMenual("전체 상품 선택을 취소했습니다."); 
        }
      }

      function allFocus(e) {
        VoiceMenual("장바구니에 담긴 상품을 전체 선택 원할 경우 스페이스바 눌러주세요.");
      } 

      function productDel(e) {
        VoiceMenual("현재 상품을 삭제 원할 경우 스페이스바 두번 눌러주세요.");
      }
      function patMove(e) {
        let productPay = $('#productPrice').text();
        let salePay = $('#salePrice').text();
        let deliveryPay = $('#deliveryPrice').text();
        let totalPay = $('#totalPrice').text();
        VoiceMenual(`상품금액은 ${productPay}. 할인된 금액은 ${salePay}. 배송비는 ${deliveryPay}. 총 결제 금액은 ${totalPay}. 입니다.
                     상품 선택을 마치셨다면. 엔터키 사용하여. 선택한 상품을 가지고. 주문 페이지로. 이동합니다.`);
      }
      function proKeydown(e) {
        if(e.keyCode === 32 && $('input[name="price"]').is(':checked') == false) {
            VoiceMenual("상품 선택 되었습니다.");
          } else if(e.keyCode === 32 && $('input[name="price"]').is(':checked') == true){
            VoiceMenual("상품 선택을 취소했습니다."); 
          }               
      }
      function shoping(e){
        VoiceMenual("장바구니 상품이 더 이상 없습니다. 쇼핑 계속 원할 경우 엔터 결제 원할 경우. alt, 1를 눌러 결제하기로 이동하세요.");
      }
      



$('#payMove').on('click', function(){
  let obj;
  let cartId;
  let cartCodeList = [];
  let checkboxes = $('input[name="price"]:checked');
        checkboxes.each((idx, tag) => {
          console.log($(tag).next().next().next());
          cartId = $(tag).next().next().next().val();
          obj = {'cartCode' : cartId};
          cartCodeList.push(cartId);
          console.log(cartCodeList);
        })

        if(cartId == null) {
          alert('결제할 상품이 없습니다.');
          location.href = location.href;
          return;
        } else {
          let params = cartCodeList;
          console.log(params);
          sendPost('/orders/pay',params);
        }       
	});

	function sendPost(url, parames) {
		console.log(parames);
          let form = document.createElement('form');
          form.setAttribute('method', 'post');
          form.setAttribute('action', url);
          document.charset = "UTF-8";

           for(let key in parames) {
             let hiddenField = document.createElement('input');
             hiddenField.setAttribute('type','hidden');
             hiddenField.setAttribute('name', "cartCode");
             hiddenField.setAttribute('value',parames[key]);
             form.appendChild(hiddenField);
           }
          document.body.appendChild(form);
          // form.appendChild(hiddenField);
          console.log(form);
          form.submit();
	}
	

    </script>
    <script src="/js/cart.js"></script>
</div>
</html>